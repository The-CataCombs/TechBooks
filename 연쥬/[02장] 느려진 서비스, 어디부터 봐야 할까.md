## ⚠️ 2장 느려진 서비스, 어디부터 봐야 할까

### 🧠 책을 읽기 전에

- 목표: 성능과 관련해 주워들은 산발적인 지식들을 내 걸로 만들어 보자!

### **📌 인상 깊은 내용**

#### ✅ DB 커넥션 풀의 대기 시간

- 30초 기본값에서 0.5~3초로 짧게 설정하면, 커넥션을 얻지 못했을 때 빠르게 에러 응답을 보내서 서버 부하 증가를 방지할 수 있다.

<div align="center">
  <image src='./images/2-1.png' width='500px' />
</div>

- 회사 코드를 확인해보니 기본값인 30초로 되어있음. 다시 돌아간다면 수정을 건의해봐야겠어요.

#### ✅ DB와의 연결이 끊긴 커넥션을 사용한다면?

- 커넥션 풀이 어처피 재연결 해줄텐데 굳이 최대 유휴 시간 등을 설정해야할까?!

- 시나리오 1: 타임아웃 설정 없이 자동 재연결만

  ```java
  // 사용자 요청 발생
  Connection conn = pool.getConnection(); // 끊긴 연결 반환
  stmt.executeQuery("SELECT * FROM users"); // ❌ SQLException 발생!
  // 그 다음에야 재연결 시도...
  ```

- 시나리오 2: 타임아웃 설정 + 자동 재연결

  ```java
  // 백그라운드에서 미리 끊긴 연결들 정리
  // 사용자 요청 발생
  Connection conn = pool.getConnection(); // ✅ 정상 연결 반환
  stmt.executeQuery("SELECT * FROM users"); // ✅ 바로 성공!
  ```

- 에러 발생 여부

  ```
  타임아웃 설정 없으면:
  사용자 → [끊긴 연결 사용] → SQLException → 재연결 → 재시도 → 성공
          ^^^^^^^^^^^^^^^^^^^^
          이 부분에서 에러 발생!

  타임아웃 설정 있으면:
  백그라운드 → [끊긴 연결 미리 제거] → 새 연결 준비
  사용자 → [정상 연결 사용] → 바로 성공!
  ```

=> 최대 유휴 시간, 최대 유지 시간을 설정하도록 하자.

#### ✅ 커넥션 풀 최소 크기

- 트래픽이 순간적으로 급증하는 패턴을 보인다면 커넥션 풀의 최소 크기를 최대 크기에 맞추는 것이 좋다. 트래픽 급증 시 DB 연결 시간도 성능 저하의 주요 원인이 될 수 있기 때문이다.

#### ✅ 캐시 사전 적재

- 푸시 알림을 보내기 전에 각 사용자의 요금 정보를 캐시에 미리 저장해두면 캐시 적중률을 99%에 가깝게 유지할 수 있다.

#### ✅ 캐시 무효화

- 캐시에 저장된 데이터의 특성에 따라 캐시를 무효화하는 시점을 달리 설정해야 함
  - 즉시 무효화
    - 변경에 민감한 데이터는 리모트 캐시에 보관해야함
    - ex) 게시글 내용
  - 주기적으로 갱신
    - 변경에 민감하지 않고 데이터 크기가 작다면 유효시간을 설정하여 주기적으로 갱신
    - ex) 최근 인기 글 목록
- 프론트에서도 일부 서버 데이터를 캐싱해서 썼었는데, 결제 후 포인를 초기화 안시켜줘서 포인트 차감이 안된 것 같다는 오해(?)의 VOC를 받은 적이 있음.. 캐싱할 땐 조심 또 조심.

#### ✅ 한 번에 대량으로 객체를 생성하는 경우

- 실제 회사에서 엑셀 다운로드, 메일 전송 기능으로 다량의 데이터를 보내다가 OOM발생한 적이 있었음
  - 조회기간 제한을 둬서 조치해둠

#### ✅ 정적 자원

- 맨날 React만 하다가 JSP를 했을 때 마주한 불편했던 점..
- JSP:
  - 파일명 고정 → 브라우저 캐싱 문제 -> 강력 새로고침해야함 ㅠㅠ
  - 수동 캐시 관리 필요
  ```
  <!-- 브라우저가 이렇게 캐싱 -->
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/app.js"></script>
  <!-- 파일명이 같아서 브라우저가 새 파일인지 모름 -->
  ```
- React (Webpack/Vite):
  - 파일 내용 변경 시 해시 변경 → 자동 캐시 무효화
  - [contenthash] 사용으로 변경된 파일만 새로 다운로드
  ```
  <!-- 매번 다른 파일명 생성 -->
  <script src="/static/js/main.a8b9c7d2.js"></script>
  <link href="/static/css/main.f6e4d8a1.css" rel="stylesheet">
  ```

---

### 🔍 추가로 읽어본 글

- [REDIS 캐시 설계 전략 지침](https://inpa.tistory.com/entry/REDIS-%F0%9F%93%9A-%EC%BA%90%EC%8B%9CCache-%EC%84%A4%EA%B3%84-%EC%A0%84%EB%9E%B5-%EC%A7%80%EC%B9%A8-%EC%B4%9D%EC%A0%95%EB%A6%AC?utm_source=chatgpt.com)
- [싱글벙글 회원 서비스 성능 튜닝기](https://tech.socarcorp.kr/dev/2023/07/22/member-service-performance-tuning-01.html?utm_source=chatgpt.com)

### 💭 더 알아보고 싶은 개념

- 분산 트랜잭션 성능

### 🤔 질문

- 사내 모니터링 시스템을 잘 활용하는지?

---

## 🎯 소감

- 채팅 로그 보는 화면에 polling을 하는 로직이 있었음.

  - 채팅창을 한개 띄우는 거 -> 여러개 띄우는 걸로 수정하면서 부하 테스트를 해보라는 지시를 받음
  - '채팅로그 한 사람이 많이 띄워봤자 몇개 안된다' 해서 그냥 테스트 정밀하게 안하고 배포했었음..
  - 다음에 또 이런 상황을 마주한다면 이런 개념들을 녹여서 테스트 해보고 싶음

- 코딩하고 싶다..
