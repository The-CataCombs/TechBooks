# ğŸš“ 6ì¥ ë™ì‹œì„±, ë°ì´í„°ê°€ ê¼¬ì´ê¸° ì „ì— ì¡ì•„ì•¼ í•œë‹¤

## ğŸ§  ì±…ì„ ì½ê¸° ì „ì—

## **ğŸ“Œ ë‚´ìš© ì •ë¦¬**

### âœï¸ í”„ë¡œì„¸ìŠ¤ ìˆ˜ì¤€ì—ì„œì˜ ë™ì‹œ ì ‘ê·¼ ì œì–´

#### âœ… 1. ì ê¸ˆ(lock)ì„ ì´ìš©í•œ ì ‘ê·¼ ì œì–´

- í”„ë¡œì„¸ìŠ¤ ìˆ˜ì¤€ì—ì„œ ë°ì´í„°ë¥¼ ë™ì‹œì— ìˆ˜ì •í•˜ëŠ” ê²ƒì„ ë§‰ê¸° ìœ„í•œ ì¼ë°˜ì ì¸ ë°©ë²•
- ì ê¸ˆì„ ì‚¬ìš©í•˜ë©´ ê³µìœ  ìì›ì— ì ‘ê·¼í•˜ëŠ” ìŠ¤ë ˆë“œë¥¼ í•œ ë²ˆì— í•˜ë‚˜ë¡œ ì œí•œí•  ìˆ˜ ìˆìŒ

```java
// HashMapì€ ë‹¤ì¤‘ ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ì•ˆì „í•˜ì§€ ì•ŠìŒ.
// ë™ì‹œì— ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ HashMapì˜ put() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ë©´ ë°ì´í„°ê°€ ìœ ì‹¤ë˜ê±°ë‚˜ ê°’ì´ ì˜ëª» ì €ì¥ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ
// ì´ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì ê¸ˆ(ReentrantLock)ì„ ì‚¬ìš©í•´ì„œ sessions í•„ë“œì— í•œ ë²ˆì— í•œ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì œí•œ
// ReentrantLockëŠ” 1ë²ˆì— 1ê°œì˜ ìŠ¤ë ˆë“œë§Œ ì ê¸ˆì„ êµ¬í•  ìˆ˜ ìˆìŒ
public class UserSessions {
  private Lock lock = new ReentrantLock();
  private Map<String, UserSession> sessions = new HashMap<>();

  public void addUserSession(UserSession session) {
    lock.lock(); // ì ê¸ˆ íšë“í•  ë•Œê¹Œì§€ ëŒ€ê¸°
    try {
      sessions.put(session.getSessionId(), session); // ê³µìœ  ìì› ì ‘ê·¼
    } finally {
      lock.unlock(); // ì ê¸ˆ í•´ì œ
    }
  }

  public UserSession getUserSession(String sessionId) {
    lock.lock();
    try {
      return sessions.get(sessionId);
    } finally {
      lock.unlock();
    }
  }
}
```

#### âœ… `synchronized`ì™€ `ReetrantLock`

- synchronized
  - ë” ê°„ë‹¨í•˜ê²Œ ìŠ¤ë ˆë“œì˜ ë™ì‹œ ì ‘ê·¼ì„ ì œì–´í•  ìˆ˜ ìˆìŒ
  - ì½”ë“œ ë¸”ë¡ì´ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ì ê¸ˆì„ í’€ì–´ì£¼ê¸° ë•Œë¬¸ì— unlock()ê³¼ ê°™ì€ ë©”ì„œë“œë¥¼ í˜¸ì¶œí•  í•„ìš”ë„ ì—†ìŒ
- ReetrantLock
  - synchronizedì— ì—†ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•¨
  - ex. ì ê¸ˆ íšë“ ëŒ€ê¸° ì‹œê°„ì„ ì§€ì •í•˜ëŠ” ê¸°ëŠ¥
- ìë°” 21ë²„ì „ì— ì¶”ê°€ëœ ê°€ìƒ ìŠ¤ë ˆë“œê°€ ì•„ì§ì€ ReetrantLockë§Œ ì§€ì›. synchronizedëŠ” ìë°” 24 ë²„ì „ë¶€í„° ì§€ì›í•˜ê³  ìˆìŒ
- ë‘ ë°©ì‹ì„ ì„ì–´ì„œë§Œ ì‚¬ìš©í•˜ì§€ ë§ê¸°!!

#### âœ… ë®¤í…ìŠ¤ (mutex)

- mutual exclusionì˜ ì¤„ì„ë§
- 'ì ê¸ˆ'ì´ë¼ê³ ë„ í•¨
- í”„ë¡œê·¸ë˜ë° ì–¸ì–´ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì”€
- Goì–¸ì–´ëŠ” íí…ìŠ¤ ì‚¬ìš©

#### âœ… 2. ì„¸ë§ˆí¬ì–´

- ë™ì‹œì— ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ìŠ¤ë ˆë“œ ìˆ˜ë¥¼ ì œí•œí•¨
- ìì›ì— ëŒ€í•œ ì ‘ê·¼ì„ ì¼ì • ìˆ˜ì¤€ìœ¼ë¡œ ì œí•œí•˜ê³  ì‹¶ì„ ë•Œ ì„¸ë§ˆí¬ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
- í¼ë°‹: í—ˆìš© ê°€ëŠ¥í•œ ìˆ«ì

```java
import java.util.concurrent.Semaphore;

public class MyClient {
  private Semaphore semaphore = new Semaphore(5);

  public String getData() {
    try {
      semaphore.acquire(); // í¼ë°‹ íšë“ ì‹œë„
    } catch (InterruptedException e) {
      throw new RuntimeException(e);
    }
    try {
      String data = ... // ì™¸ë¶€ ì—°ë™ ì½”ë“œ
      return data;
    } finally {
      semaphore.release(); // í¼ë°‹ ë°˜í™˜
    }
  }
}
```

#### âœ… 3. ì½ê¸° ì“°ê¸° ì ê¸ˆ

- ì“°ê¸° ì ê¸ˆ: í•œ ë²ˆì— í•œ ìŠ¤ë ˆë“œë§Œ êµ¬í•  ìˆ˜ ìˆìŒ
- ì½ê¸° ì ê¸ˆ: í•œ ë²ˆì— ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ êµ¬í•  ìˆ˜ ìˆìŒ
- ì“°ê¸° ì ê¸ˆì„ íšë“í–ˆë‹¤ë©´ ì“°ê¸° ì ê¸ˆì´ í•´ì œë  ë•Œê¹Œì§€ ì½ê¸° ì ê¸ˆì„ êµ¬í•  ìˆ˜ ì—†ìŒ
- ì½ê¸° ì ê¸ˆì„ íšë“í–ˆë‹¤ë©´ ì½ê¸° ì ê¸ˆì´ í•´ì œë  ë•Œê¹Œì§€ ì“°ê¸° ì ê¸ˆì„ êµ¬í•  ìˆ˜ ì—†ìŒ

```java
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReadWriteLock;
import java.util.concurrent.locks.ReentrantReadWriteLock;

public class UserSessionRW {
  private ReadWriteLock lock = new ReentrantReadWriteLock();
  private Lock writeLock = lock.writeLock();
  private Lock readLock = lock.readLock();
  private Map<String, UserSession> sessions = new HashMap<>();

  public void addUserSession(UserSession session) {
    writeLock.lock();
    try {
      sessions.put(session.getSessionId(), session);
    } finally {
      writeLock.unlock();
    }
  }

  public UserSession getUserSession(String sessionId) {
    readLock.lock();
    try {
      return sessions.get(sessionId);
    } finally {
      readLock.unlock();
    }
  }
}
```

#### âœ… ì›ìì  íƒ€ì…(Atomic Type)

```java
import java.util.concurrent.atomic.AtomicInteger;

public class Increaser {
  private AtomicInteger count = new AtomicInteger(0);

  public void inc() {
    count.incrementAndGet(); // ë‹¤ì¤‘ ìŠ¤ë ˆë“œ ë¬¸ì œì—†ì´ ê°’ì„ 1 ì¦ê°€ì‹œí‚´
  }

  public int getCount() {
    return count.get();
  }
}
```

- AtomicIntegerëŠ” ë‚´ë¶€ì ìœ¼ë¡œ CAS ì—°ì‚°ì„ ì‚¬ìš©í•¨.

  - ì´ë¥¼ í†µí•´ ìŠ¤ë ˆë“œë¥¼ ë©ˆì¶”ì§€ ì•Šê³ ë„ ë‹¤ì¤‘ ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ì•ˆì „í•˜ê²Œ ê°’ì„ ë³€ê²½í•  ìˆ˜ ìˆìŒ
  - ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— count, incrementAndGet()ì„ ì‹¤í–‰í•´ë„ ëª¨ë“  ìŠ¤ë ˆë“œê°€ ë©ˆì¶”ì§€ ì•Šê³  ì‹¤í–‰ë˜ë¯€ë¡œ CPU íš¨ìœ¨ì„ ë†’ì¼ ìˆ˜ ìˆìŒ

- CAS: Compare And Swap

#### âœ… ë™ì‹œì„± ì§€ì› ì»¬ë ‰ì…˜

- ìŠ¤ë ˆë“œì— ì•ˆì „í•˜ì§€ ì•Šì€ ì»¬ë ‰ì…˜ì„ ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ ê³µìœ í•˜ë©´ ë™ì‹œì„± ë¬¸ì œê°€ ìƒê¸¸ ìˆ˜ ìˆìŒ
  - HashMap, HashSet
- Collections í´ë˜ìŠ¤: ë™ê¸°í™”ëœ ì»¬ë ‰ì…˜ì„ ìƒì„±í•˜ëŠ” ë©”ì„œë“œë¥¼ ì œê³µí•¨.

  ```java
  Map<String, String> map = new HashMap<>();
  // ë™ê¸°í™”ëœ ì»¬ë ‰ì…˜ ê°ì²´ ìƒì„±
  Map<String, String> syncMap = Collections.synchronizedMap(map);
  syncMap.put("key1", "value1"); // put ë©”ì„œë“œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ synchronizedë¡œ ì²˜ë¦¬ë¨
  ```

- ConcurrentHashMap: ë™ì‹œì„± ìì²´ë¥¼ ì§€ì›í•˜ëŠ” ì»¬ë ‰ì…˜
  - ë°ì´í„°ë¥¼ ë³€ê²½í•  ë•Œ ì ê¸ˆ ë²”ìœ„ë¥¼ ìµœì†Œí™”í•¨
  - í‚¤ì˜ í•´ì‹œ ë¶„í¬ê°€ ê³ ë¥´ê³  ë™ì‹œ ìˆ˜ì •ì´ ë§ìœ¼ë©´, ë™ê¸°í™”ëœ ë§µì„ ì‚¬ìš©í•˜ëŠ” ê²ƒë³´ë‹¤ ë” ë‚˜ì€ ì„±ëŠ¥ì„ ì œê³µí•¨
- ë¶ˆë³€ê°’
  - ë™ì‹œì„± ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•œ ë°©ë²• ì¤‘ í•˜ë‚˜
  - ë°ì´í„° ë³€ê²½ì´ í•„ìš”í•  ê²½ìš°, ê¸°ì¡´ ê°’ì„ ìˆ˜ì •í•˜ëŠ” ëŒ€ì‹  ìƒˆë¡œìš´ ê°’ì„ ìƒì„±í•´ì„œ ì‚¬ìš©í•¨
  - ex. CopyOnWriteArrayList

### âœï¸ DBì™€ ë™ì‹œì„±

#### âœ… ì„ ì  ì ê¸ˆ (ë¹„ê´€ì  ì ê¸ˆ)

- ë™ì¼í•œ ë ˆì½”ë“œì— ëŒ€í•´ í•œ ë²ˆì— í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì œì–´
- ì‹¤íŒ¨í•  ê°€ëŠ¥ì„±ì´ ë†’ì•„ì„œ ë¹„ê´€ì  (ë‹¤ìˆ˜ê°€ ë°ì´í„° ë³€ê²½ì„ ì‹œë„í•˜ë©´ ë°ì´í„°ë¥¼ ì •ìƒì ìœ¼ë¡œ ë³€ê²½í•  ê°€ëŠ¥ì„±ì´ ë–¨ì–´ì§ˆ í…Œë‹ˆ)
  - ì‹¤íŒ¨ ê°€ëŠ¥ì„±ì´ ë†’ì€ ë¹„ê´€ì ì¸ ìƒí™©ì—ì„œëŠ” ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ í•œ ë²ˆì— 1ê°œ í´ë¼ì´ì–¸íŠ¸ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë°°íƒ€ì  ì ê¸ˆì„ ì‚¬ìš©

#### âœ… ë¹„ì„ ì  ì ê¸ˆ (ë‚™ê´€ì  ì ê¸ˆ)

- ê°’ì„ ë¹„êµí•´ì„œ ìˆ˜ì •í•˜ëŠ” ë°©ì‹
- ì¿¼ë¦¬ ì‹¤í–‰ ìì²´ëŠ” ë§‰ì§€ ì•Šìœ¼ë©´ì„œë„ ë°ì´í„°ê°€ ì˜ëª» ë³€ê²½ë˜ëŠ” ê²ƒì„ ë§‰ì„ ìˆ˜ ìˆìŒ
- ë‚™ê´€ì : ì„±ê³µí•  ê°€ëŠ¥ì„±ì´ ë†’ì•„ì„œ
  - ì„±ê³µ ê°€ëŠ¥ì„±ì´ ë†’ì€ ë‚™ê´€ì ì¸ ìƒí™©ì—ì„œëŠ” ë™ì‹œì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë°°íƒ€ì  ì ê¸ˆê¹Œì§€ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
  - ëŒ€ì‹  ê°’ì„ ë¹„êµí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‹œì„± ë¬¸ì œì— ëŒ€ì‘í•¨

#### âœ… ë¶„ì‚° ì ê¸ˆ

- íŠ¸ë˜í”½ì´ ë§ë‹¤ë©´ ë ˆë””ìŠ¤ë¥¼ ì´ìš©í•´ ë¶„ì‚° ì ê¸ˆì„ êµ¬í˜„í•˜ëŠ” ê²ƒì„ ê³ ë ¤

#### âœ… ì™¸ë¶€ ì—°ë™ê³¼ ì ê¸ˆ

- ë¹„ì„ ì  ì ê¸ˆë³´ë‹¤ëŠ” ì„ ì  ì ê¸ˆì„ ê³ ë ¤í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
- ë¹„ì„ ì  ì ê¸ˆì„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ íŠ¸ëœì­ì…˜ ì•„ì›ƒë°•ìŠ¤ íŒ¨í„´ì„ ì ìš©í•´ì„œ ì™¸ë¶€ ì—°ë™ì„ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì´ ìˆìŒ

#### âœ… ì¦ë¶„ ì¿¼ë¦¬

```sql
update SUBJECT set joinCount = joinCount + 1 where id = ?
```

- DBëŠ” ë™ì¼ ë°ì´í„°ì— ëŒ€í•œ ì›ìì  ì—°ì‚°ì´ ë™ì‹œì— ì‹¤í–‰ë  ê²½ìš° ì´ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•¨
- ë”°ë¼ì„œ ë°ì´í„°ê°€ ëˆ„ë½ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ì§€ì•ŠìŒ
- ì¦ë¶„ ì¿¼ë¦¬ëŠ” DBì— ë”°ë¼ ì›ìì  ì—°ì‚°ì´ ì•„ë‹ ìˆ˜ ìˆìŒ. ë”°ë¼ì„œ ì¦ë¶„ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ì‚¬ìš©í•˜ëŠ” DBì—ì„œ ì›ìì ìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ”ì§€ ë°˜ë“œì‹œ ê²€ì¦í•´ì•¼ í•¨(?)

#### âœ… ì ê¸ˆ ì‚¬ìš© ì‹œ ì£¼ì˜ ì‚¬í•­

1. ì ê¸ˆ í•´ì œí•˜ê¸°
   ```java
   lock.lock();
   try {
     // ì½”ë“œ
   } finally {
     lock.unlock();
   }
   ```
2. ëŒ€ê¸° ì‹œê°„ ì§€ì •í•˜ê¸°

   ```java
   boolean acquired = lock.tryLock(5, TimeUnit.SECONDS);
   if (!acquired) {
     // ì ê¸ˆ íšë“ ì‹¤íŒ¨
     throw new RuntimeException("Failed to acquire lock");
   }
   // ì ê¸ˆ í‰ë“ ì„±ê³µ
   try {
     // ìì› ì ‘ê·¼ ì½”ë“œ ì‹¤í–‰
   } finally {
     lock.unlock();
   }
   ```

   ```java
   boolean acquired = lock.tryLock(); // ëŒ€ê¸° ì‹œê°„ ì—†ì´ ë°”ë¡œ ê²°ê³¼ ë°˜í™˜
   if(!acquired) {
     throw new RuntimeException("Failed to acquire lock");
   }
   ```

3. êµì°© ìƒíƒœ(deadlock) í”¼í•˜ê¸°

   - í•´ì†Œ ë°©ë²•

     - ì ê¸ˆ ëŒ€ê¸° ì‹œê°„ì„ ì œí•œí•˜ëŠ” ê²ƒ
     - ì§€ì •í•œ ìˆœì„œëŒ€ë¡œ ì ê¸ˆì„ íšë“í•˜ëŠ” ê²ƒ

- ë¼ì´ë¸Œë½(livelock) ì²¨ë“¤ì–´ë´„
- ê¸°ì•„ ìƒíƒœ

### âœï¸ ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œ ì²˜ë¦¬í•˜ê¸°

- ë°ì´í„° ë³€ê²½ì´ë‚˜ ì ‘ê·¼ì´ í•„ìš”í•œ ìŠ¤ë ˆë“œëŠ” ì‘ì—… íì— í•„ìš”í•œ ì‘ì—…ì„ ì¶”ê°€í•  ë¿ ì§ì ‘ ìƒíƒœì— ì ‘ê·¼í•˜ì§€ ëª»í•¨

```java
while (running) {
  // í•œ ìŠ¤ë ˆë“œë§Œ íì—ì„œ ì‘ì—…ì„ êº¼ë‚´ì„œ ì‹¤í–‰í•¨
  Job job = jobQueue.poll(1, TimeUnit.SECONDS);
  if (job == null) {
    continue;
  }

  // job ì¢…ë¥˜ì— ë”°ë¼ ìƒíƒœ ì²˜ë¦¬
  switch (job.getType()) {
    case INC:
      // modifyState()ëŠ” í•œ ìŠ¤ë ˆë“œë§Œ ì ‘ê·¼í•˜ë¯€ë¡œ ë™ì‹œì„± ë¬¸ì œê°€ ì—†ìŒ
      obj.modifyState();
      break;
    // ...ë‹¤ë¥¸ ì‘ì—…
  }
  // ...
}
```

- ë‘ ìŠ¤ë ˆë“œê°€ ë°ì´í„° ê³µìœ ê°€ í•„ìš”í•˜ë©´?!

  - ì½œë°±ì´ë‚˜ íì™€ ê°™ì€ ìˆ˜ë‹¨ì„ ì‚¬ìš©í•´ì„œ ë°ì´í„° ë³µì œë³¸ì„ ê³µìœ í•¨
  - ë³µì œë³¸ ëŒ€ì‹  ë¶ˆë³€ê°’ì„ ê³µìœ í•˜ê¸°ë„ í•¨

- Go ì–¸ì–´

  - ë©”ëª¨ë¦¬ë¥¼ ê³µìœ í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì†Œí†µí•˜ì§€ ë§ê³  í†µì‹ ì„ í†µí•´ ë©”ëª¨ë¦¬ë¥¼ ê³µìœ í•˜ë¼
  - Goì–¸ì–´ëŠ” ì±„ë„ì„ í†µí•´ ë°ì´í„°ë¥¼ ê³µìœ í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë™ì‹œì„±ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŒ

- ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œ ì²˜ë¦¬í•œë‹¤ë©´?
  - ì¥ì : ë™ì‹œì„± ë¬¸ì œì—ì„œ ììœ ë¡œìš¸ ìˆ˜ ìˆìŒ
  - ë‹¨ì : êµ¬ì¡°ëŠ” ë³µì¡í•´ì§
  - ë…¼ë¸”ë¡œí‚¹ì´ë‚˜ ë¹„ë™ê¸° IOë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ì—ëŠ” ë¸”ë¡œí‚¹ ì—°ì‚°ì„ ìµœì†Œí™”í•´ì•¼ í•˜ë¯€ë¡œ ë‹¨ì¼ ìŠ¤ë ˆë“œ ì²˜ë¦¬ ë°©ì‹ì´ ì í•©í•¨

---

## ğŸ’­ ì •ë¦¬

```
- í”„ë¡œì„¸ìŠ¤ ìˆ˜ì¤€ì—ì„œì˜ ë™ì‹œ ì ‘ê·¼ ì œì–´
  1. ì ê¸ˆ(lock)ì„ ì´ìš©í•œ ì ‘ê·¼ ì œì–´ - ë®¤í…ìŠ¤
     - synchronized
     - ReetrantLock
  2. ì„¸ë§ˆí¬ì–´
    - ë™ì‹œì— ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ìŠ¤ë ˆë“œ ìˆ˜ ì œí•œ
  3. ì½ê¸° ì“°ê¸° ì ê¸ˆ
  - ê³µìœ ì¤‘ì¸ ê°€ë³€ ë°ì´í„° ë™ê¸°í™”
    - ì›ìì  íƒ€ì…
      - AtomicInteger
      - CAS
    - ë™ì‹œì„± ì§€ì› ì»¬ë ‰ì…˜
      - ConcurrentHashMap, ë¶ˆë³€ê°’(CopyOnWriteArrayList)

- DBì™€ ë™ì‹œì„±
  - ì„ ì  ì ê¸ˆ (ë¹„ê´€ì  ì ê¸ˆ)
    - ë™ì¼í•œ ë ˆì½”ë“œì— ëŒ€í•´ í•œ ë²ˆì— í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ë§Œ ì ‘ê·¼ ê°€ëŠ¥
    - ì‹¤íŒ¨ ê°€ëŠ¥ì„±ì´ ë†’ì€ ë¹„ê´€ì ì¸ ìƒí™©ì—ì„œ ì‚¬ìš©
    - ì™¸ë¶€ ì—°ë™ì‹œ ì„ ì  ì ê¸ˆì„ ê³ ë ¤í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ.
  - ë¹„ì„ ì  ì ê¸ˆ (ë‚™ê´€ì  ì ê¸ˆ)
    - ê°’ì„ ë¹„êµí•´ì„œ ìˆ˜ì •í•˜ëŠ” ë°©ì‹
    - ì„±ê³µí•  ê°€ëŠ¥ì„±ì´ ë†’ì€ ë‚™ê´€ì ì¸ ìƒí™©ì—ì„œ ì‚¬ìš©
    - ì™¸ë¶€ ì—°ë™ì‹œ ë¹„ì„ ì  ì ê¸ˆì„ ì‚¬ìš©í•˜ê³  ì‹¶ë‹¤ë©´ íŠ¸ëœì­ì…˜ ì•„ì›ƒë°•ìŠ¤ íŒ¨í„´ ì ìš©í•˜ê¸°
  - ë¶„ì‚° ì ê¸ˆ
    - íŠ¸ë˜í”½ì´ ë§ë‹¤ë©´ ë ˆë””ìŠ¤ë¥¼ ì´ìš©í•´ ë¶„ì‚° ì ê¸ˆì„ êµ¬í˜„í•˜ëŠ” ê²ƒì„ ê³ ë ¤
  - ì¦ë¶„ ì¿¼ë¦¬
    - DBëŠ” ë™ì¼ ë°ì´í„°ì— ëŒ€í•œ ì›ìì  ì—°ì‚°ì´ ë™ì‹œì— ì‹¤í–‰ë  ê²½ìš° ì´ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰í•¨
    - ì¦ë¶„ ì¿¼ë¦¬ëŠ” DBì— ë”°ë¼ ì›ìì  ì—°ì‚°ì´ ì•„ë‹ ìˆ˜ ìˆìŒ. ë”°ë¼ì„œ ì¦ë¶„ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•  ë•ŒëŠ” ì‚¬ìš©í•˜ëŠ” DBì—ì„œ ì›ìì ìœ¼ë¡œ ì²˜ë¦¬ë˜ëŠ”ì§€ ë°˜ë“œì‹œ ê²€ì¦í•´ì•¼ í•¨(?)

- ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œ ì²˜ë¦¬í•˜ê¸°
```

### ğŸ¤” **`volatile` í‚¤ì›Œë“œë¥¼ í™œìš©í•œ ê°„ë‹¨í•œ ë™ê¸°í™” ë° í•œê³„**

- **`volatile`** í‚¤ì›Œë“œëŠ” ë³€ìˆ˜ë¥¼ ë©”ì¸ ë©”ëª¨ë¦¬ì— ë°”ë¡œ ì½ê³  ì“°ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.
- ëª¨ë“  ìŠ¤ë ˆë“œê°€ ë³€ìˆ˜ì˜ ìµœì‹  ê°’ì„ ì½ë„ë¡ ë³´ì¥í•˜ì§€ë§Œ, **ë°°íƒ€ì  ì‹¤í–‰ì€ ë³´ì¥í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**

```java
// ë³´ì¥í•˜ëŠ” ê±°
public class VolatileExample {
    private static volatile boolean flag = false;
    private static volatile int counter = 0;

    public static void main(String[] args) throws InterruptedException {
        // ìŠ¤ë ˆë“œ 1: ê°’ì„ ë³€ê²½
        Thread writer = new Thread(() -> {
            counter = 42;
            flag = true;  // âœ… ì¦‰ì‹œ ë©”ì¸ ë©”ëª¨ë¦¬ì— ë°˜ì˜
        });

        // ìŠ¤ë ˆë“œ 2: ê°’ì„ ì½ê¸°
        Thread reader = new Thread(() -> {
            while (!flag) {  // âœ… ìµœì‹  ê°’ì„ ë©”ì¸ ë©”ëª¨ë¦¬ì—ì„œ ì½ìŒ
                // ëŒ€ê¸°
            }
            System.out.println("Counter: " + counter); // âœ… 42 ì¶œë ¥ ë³´ì¥
        });

        writer.start();
        reader.start();
    }
}
```

```java
// ë³´ì¥í•˜ì§€ ì•ŠëŠ” ê²ƒ
public class VolatileProblem {
    private static volatile int sharedCounter = 0;

    public static void main(String[] args) throws InterruptedException {
        // 10ê°œì˜ ìŠ¤ë ˆë“œê°€ ë™ì‹œì— ì¹´ìš´í„° ì¦ê°€
        Thread[] threads = new Thread[10];

        for (int i = 0; i < 10; i++) {
            threads[i] = new Thread(() -> {
                for (int j = 0; j < 1000; j++) {
                    sharedCounter++;  // âŒ ì›ìì ì´ì§€ ì•ŠìŒ!
                }
            });
        }

        // ëª¨ë“  ìŠ¤ë ˆë“œ ì‹œì‘
        for (Thread thread : threads) {
            thread.start();
        }

        // ëª¨ë“  ìŠ¤ë ˆë“œ ì¢…ë£Œ ëŒ€ê¸°
        for (Thread thread : threads) {
            thread.join();
        }

        System.out.println("Expected: 10000");
        System.out.println("Actual: " + sharedCounter); // ì‹¤ì œë¡œëŠ” 10000ë³´ë‹¤ ì‘ìŒ!
    }
}
```

- **í•œê³„**
  - ë³µí•© ì—°ì‚°(ì˜ˆ: `i++`)ì€ ì—¬ì „íˆ ì›ìì ì´ì§€ ì•Šì•„ **ë™ê¸°í™”**ê°€ í•„ìš”í•´ìš”.
  - ì˜ˆë¥¼ ë“¤ì–´, `volatile`ë¡œ ì„ ì–¸ëœ ë³€ìˆ˜ì— `++` ì—°ì‚°ì„ ìˆ˜í–‰í•˜ë©´ ì—¬ì „íˆ ë°ì´í„° ë¶ˆì¼ì¹˜ê°€ ë°œìƒí•  ìˆ˜ ìˆì–´ìš”.

### ğŸ¤” **Lock-Free ë™ê¸°í™”ë€?**

- **Lock-Free ë™ê¸°í™”**ëŠ” ìŠ¤ë ˆë“œê°€ ë½(lock)ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë™ê¸°í™”ë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì´ì—ìš”.
- ì „í†µì ì¸ ë™ê¸°í™”(`synchronized` ë˜ëŠ” `ReentrantLock`)ëŠ” íŠ¹ì • ì½”ë“œ ë¸”ë¡ì´ë‚˜ ë°ì´í„°ì— ëŒ€í•œ ì ‘ê·¼ì„ **ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬**í•˜ë„ë¡ ìŠ¤ë ˆë“œë¥¼ ëŒ€ê¸°ì‹œí‚¤ëŠ” ë°˜ë©´, **Lock-Free ë™ê¸°í™”**ëŠ” ëŒ€ê¸°í•˜ì§€ ì•Šê³  ì‘ì—…ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
- ì´ë¥¼ í†µí•´ **ì„±ëŠ¥ì„ ê·¹ëŒ€í™”**í•˜ê³ , **êµì°© ìƒíƒœ(Deadlock)**ë‚˜ **ìŠ¤ë ˆë“œ ê¸°ì•„(Starvation)** ê°™ì€ ë¬¸ì œë¥¼ ë°©ì§€í•  ìˆ˜ ìˆì–´ìš”.

#### ğŸ“Œ **Lock-Free ë™ê¸°í™”ì˜ í•µì‹¬**

1. **ì›ìì  ì—°ì‚°(Atomic Operation)**
   - Lock-Free ë™ê¸°í™”ëŠ” ì›ìì  ì—°ì‚°ì„ ì‚¬ìš©í•´ìš”.
   - ì›ìì  ì—°ì‚°ì€ **ì¤‘ê°„ì— ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ê°œì…í•  ìˆ˜ ì—†ëŠ” ì—°ì‚°**ì„ ì˜ë¯¸í•´ìš”.
   - EX) `compareAndSet`(CAS) ì—°ì‚°ì€ ë°ì´í„° ë³€ê²½ ì „ì— í˜„ì¬ ê°’ì´ ê¸°ëŒ€í•œ ê°’ì¸ì§€ í™•ì¸í•˜ê³ , ê·¸ë ‡ë‹¤ë©´ ìƒˆë¡œìš´ ê°’ìœ¼ë¡œ êµì²´í•©ë‹ˆë‹¤.
2. **CAS(Compare-And-Swap) ì—°ì‚°**
   - Lock-Free ë™ê¸°í™”ì˜ ì¤‘ì‹¬ì´ ë˜ëŠ” ê¸°ìˆ ì´ì—ìš”.
   - CASëŠ” ì„¸ ê°€ì§€ ê°’ì„ ì…ë ¥ìœ¼ë¡œ ë°›ìŠµë‹ˆë‹¤.
     1. ë©”ëª¨ë¦¬ ìœ„ì¹˜
     2. ê¸°ëŒ€ê°’ (Expected Value)
     3. ìƒˆ ê°’ (New Value)
   - ë©”ëª¨ë¦¬ ìœ„ì¹˜ì— ì €ì¥ëœ ê°’ì´ ê¸°ëŒ€ê°’ê³¼ ê°™ìœ¼ë©´ ìƒˆ ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ê³ , ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì•„ë¬´ ì‘ì—…ë„ í•˜ì§€ ì•Šì•„ìš”.
   - **ì¥ì **
     - ë§¤ìš° ë¹ ë¦…ë‹ˆë‹¤.
     - ìŠ¤ë ˆë“œê°€ ëŒ€ê¸°í•˜ì§€ ì•Šê³ ë„ ë°ì´í„° ì¼ê´€ì„±ì„ ìœ ì§€í•  ìˆ˜ ìˆì–´ìš”.

#### ğŸ“Œ `java.util.concurrent.atomic` íŒ¨í‚¤ì§€

- `java.util.concurrent.atomic` íŒ¨í‚¤ì§€ëŠ” **lock-free ë™ê¸°í™”**ë¥¼ ì œê³µí•´ìš”.
- **ëŒ€í‘œì ì¸ í´ë˜ìŠ¤: `AtomicLong`, `AtomicInteger`**

#### ğŸ“Œ ëŒ€í‘œì ì¸ í´ë˜ìŠ¤: **`AtomicLong`**

- `AtomicLong`ì€ `long` íƒ€ì…ì˜ ë³€ìˆ˜ë¥¼ ì›ìì ìœ¼ë¡œ ì½ê³  ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ëœ í´ë˜ìŠ¤ì…ë‹ˆë‹¤.
- ì´ë¥¼ í†µí•´ ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œë„ ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.
- **AtomicLong ì‚¬ìš© ì˜ˆì‹œ**

  ```java
  import java.util.concurrent.atomic.AtomicLong;

  public class AtomicExample {
      private static final AtomicLong counter = new AtomicLong();

      public static long generateNumber() {
          return counter.getAndIncrement(); // ì›ìì ìœ¼ë¡œ ê°’ì„ ì¦ê°€
      }

      public static void main(String[] args) {
          Thread t1 = new Thread(() -> {
              for (int i = 0; i < 5; i++) {
                  System.out.println("Thread 1: " + generateNumber());
              }
          });

          Thread t2 = new Thread(() -> {
              for (int i = 0; i < 5; i++) {
                  System.out.println("Thread 2: " + generateNumber());
              }
          });

          t1.start();
          t2.start();
      }
  }

  // ì¶œë ¥
  Thread 1: 0
  Thread 2: 1
  Thread 1: 2
  Thread 2: 3
  Thread 1: 4
  Thread 2: 5
  ...
  ```

  - **ì¥ì **
    1. **ê³ ì„±ëŠ¥**: `synchronized` ì—†ì´ ì›ìì  ì—°ì‚°ì„ ìˆ˜í–‰í•˜ë¯€ë¡œ ì„±ëŠ¥ì´ ìš°ìˆ˜í•´ìš”.
    2. **ì•ˆì „ì„±**: ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œë„ ë°ì´í„° ì¼ê´€ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

- [í† ìŠ¤ SLASH 22, ì• í”Œ í•œ ì£¼ê°€ ê³ ê°ì—ê²Œ ì „ë‹¬ë˜ê¸° ê¹Œì§€](https://haon.blog/article/toss-slash/broker-issue-concurrency-and-network-latency/)

## ğŸ¤” ì§ˆë¬¸

## ğŸ¯ ì†Œê°
