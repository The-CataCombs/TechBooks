# 📚 개발 도서 스터디 템플릿

## 🧠 1. 책을 읽기 전에
- **기대하는 점**: 지연이 어디서 발생하는지는 알아도, 왜 발생하는지 까지 깊이 고민해보지는 못한 시간이 많았다.. 왜에 대한 단서를 알아가기
- **알고 싶은 개념 / 주제**: 커넥션 풀에 대한 이야기. 지연이 발생하면 그걸 어떻게 확인해야하는 지 등등
---

## 📂 2. 내용 정리 (자신의 언어로 요약)

### 지연
- DB Connection 풀을 닫지 않는 문제 (DB의 커넥션 풀, 스프링에서는 커넥션은 반환한다?)
- DB 커넥션 최대 연결 시간 설정 (DB에 있는 최대 연결 시간, 스프링 최대 연결 시간 모두 고려)
- API요청 처리(for - while문), DB 연동 및 쿼리 실행, 외부 API 연동, 응답(메일, 메세지 등 전송)

### 커넥션 풀
- 최소와 최대 (기본적으로는 최소로 유지, 요청이 늘어나면 풀을 최대까지 늘리다가 감소하면 다시 최소로 유지)
- 단, 트래픽이 급증한다면 커넥션 풀을 최소=최대로 유지. DB연결 자체가 성능 저하가 될 수 있음
- 커넥션 대기 시간 (대기시간을 초과한 요청은 오류를 내뱉게 된다.)
- 최대 유휴 시간(커넥션을 유지할 필요성이 있는지 확인) - DB의 경우 연결 시간을 유지하지 못하면 연결을 끊어버리기도 함
- 최대 유지 시간 (설정한 시간 만큼만 커넥션이 유지된다. 그 이후에는 풀에서 제거된다.)

### 캐시
- 서버 캐시(Map형태의 데이터 저장소로 자주 조회되는 정보를 보관해서 사용하면 좋음)
- 캐시히트는 높이는게 좋음, 하지만 캐시를 많이 활용하면 메모리 사용율이 높아져서 조정이 필요함
- 로컬 캐시 : 서버 프로세스와 동일한 메모리를 저장소로 사용한다.서버를 재시작 하면 캐시 정보가 초기화 되어 초기 응답은 느릴 수 있음
- 리모트 캐시 : 별토 프로세스를 캐시 저장소로 사용한다. 캐시 크기의 수평 확장 가능. 하지만 네트워크 통신으로 통신에 지연 발생
- 대규모 서비스, 배포 빈도가 높으면 리모트 캐시 사용이 좋음
  
#### 캐시 사전 적재, 캐시 무효화
- 사전 적재 : 트래픽이 급증하면 캐시에 데이터를 미리 저장 (정해진 주기로 정보 전달)
- 캐시 무효화
    - 유효하지 않은 데이터를 캐시에 삭제(데이터가 변경되면, 캐시에도 정보 업데이트 필요)
    - 특히 민감 데이터의 경우 캐시 무효화가 필수, 이런 캐시는 리모트에 보관하는게 더 좋음 (멀티 서버의 경우 캐시 유효성이 중요)
    - 변경에 민감하지 않고, 데이터 크기가 작으면 유효시간을 설정해 주기적 갱신 필요
      
### GC, 메모리
- 메모리 사용을 줄이면 GC 시간도 줄어든다.
- 한번에 대량 객체 생성을 주의해야 함 (=> 조회 범위를 제한해서 사용하도록 한다.)
- 파일 다운로드 같은 경우에는 스트림을 활용해 사용한다. (자바의 경우,바이트 크기를 구간별로 나누어서 데이터를 나누어서 가져올 수 있도록)

### 응답 데이터 압축, 브라우저 캐시
- 정적 파일 압축, 텍스트를 gzip 압축으로 데이터 전송 크기를 줄인다.
- nginx를 활용해서 응답 데이터를 압축해서 활용하도록 한다.
- 이미지 파일과 같은 데이터를 Cache-Control, Expires 헤더를 사용해 저장해서 사용하도록 한다. (네트워크 전송 비용 감소)
- 혹은, CDN을 활용해서 정적 자원을 관리할 수도 있음. 여러 지역에서 컨텐츠를 다운로드 해야 하는 소요가 있으면 이를 활용
- + 웹서버에서는 이미지 크기에 대한 용량 초과를 관리하는 것도 중요. (네트워크 포화 및 비용 문제)

#### 지연이 발생하는 케이스 
- 순간적으로 요청량 증가 (= TPS초과)
- 서버 재시작 후 괜찮다가 지연
- 트래픽이 줄어들 때 까지 상황 지속됨

**나의 해석 / 생각**:
- 이 개념을 어디에 적용할 수 있을까?
- 다양한 지연 원인을 현업에서 겪고 있음
    - 회사에 통계 테이블을 조회하는 로직이 있는데, 매우 비효율적인 구조로 운영중        
    - 커넥션 풀에 대한 지연 문제로 데이터 처리가 이루어지지 못한 경우
    - 무분별한 객체 생성으로 OOM이 간헐적으로 발생한 경우

---

## 💬 3. 이야기하고 싶은 질문 / 포인트

- ❓ 질문 1: 스프링에서는 커넥션 연결을 어떻게 하고 있을까?
  - 개발자는 DataSource라는 인터페이스에만 의존. 커넥션 풀은 HicariCP 구현체로 되어 있어 나중에 데이터 풀을 관리할 때에도 이 부분만 변경해주면 됨
  - 관련 개념 : HikariConfig, MyPool connection adder (여기서 별도의 스레드를 생성해서 연결을 한다. 별도의 스레드를 사용하는 이유는 연결 과정의 리소스가 크기 때문)
- ❓ 질문 2: 각 서비스에서 지연 측정은 어떻게 하고 있는지? 해결사례는 뭐가 있는지?
- ❓ 질문 3: 커넥션 최대 유지 시간은 시간이 지나고 나면 그냥 커넥션이 닫아져서 10개 미만이 되는건지?
    - Hikari는 백그라운드에서 커넥션을 미리 감시하며, maxLifetime을 초과한 커넥션을 미리 폐기 예약함
    - 하지만 실제 제거는 해당 커넥션이 사용되지 않을 때, 또는 반환되는 시점에 이루어짐
  
- 💭 더 알아보고 싶은 개념: e-tag
---

## 🎯 4. 정리 & 적용 아이디어

- 지연이 발생한 경우 요청의 순서대로 원인을 파악하기
- 지연이 발생될 것으로 예상되는 구간에 시간을 측정해두기
- 개발에 적용? : 로그나 찍어야지 회사는..

---

## 🌟 5. 전체 리뷰
평점 : 🌟🌟🌟🌟🌟
당연히 알고 있는 지연에 대한 이유들이지만, 같은 개념을 조금 더 깊이 복습해볼 수 있었음




- **별점 평가** (⭐️ 5점 만점): `⭐️⭐️⭐️⭐️`
- **책에 대한 총평**: 현재 서비스에서 점검해보고 싶은 내용이 상당부분 있음
- **이 책을 추천한다면 어떤 사람에게?** : 너희들!
