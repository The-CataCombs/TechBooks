**ğŸ“š ê°œë°œ ë„ì„œ ìŠ¤í„°ë”” í…œí”Œë¦¿**

# **ğŸ§  1. ì±…ì„ ì½ê¸° ì „ì—**

ë³´ì•ˆ â‡’ ì†”ì§íˆ ì¬ë¯¸ì—†ì„ê±°ë¼ ìƒê°í–ˆëŠ”ë° ì½ë‹¤ë³´ë‹ˆ ë– ì˜¤ë¥´ëŠ” ê²ƒë“¤ë„ ìˆê³  ì™œì¸ì§€ í¥ë¯¸ë¡œì›Œì„œ ìƒê°ë³´ë‹¤ ì¬ë¯¸ìˆê²Œ ì½ì—ˆë‹¤!

---

# **ğŸ“‚ 2. ë‚´ìš© ì •ë¦¬**

8ì¥ ê³µë¶€ë‚´ìš©

# **ğŸ’¬ 3. ì´ì•¼ê¸°í•˜ê³  ì‹¶ì€ ì§ˆë¬¸ / í¬ì¸íŠ¸**

> ì½ìœ¼ë©° ìƒê¸´Â ì˜ë¬¸,Â í™•ì¸í•˜ê³  ì‹¶ì€ ê°œë…,Â ë¹„íŒí•˜ê³  ì‹¶ì€ ì£¼ì¥Â ë“±ì„ ì ìŠµë‹ˆë‹¤.
> 

## ì¸ì¦ê³¼ í† í°

ì„œë²„ëŠ” í† í°ì„ í†µí•´ ì‚¬ìš©ìë¥¼ ì‹ë³„

## í† í°ê³¼ ì‚¬ìš©ìê°„ì˜ ë§¤í•‘ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ë‘ê°€ì§€ ë°©ë²•

### 1. ë³„ë„ ì €ì¥ì†Œì— í† í°(ê³ ìœ í•´ì•¼ í•¨)ê³¼ ì‚¬ìš©ì ì‹ë³„ ì •ë³´ ì €ì¥

### 2. í† í° ìì²´ì— ì‚¬ìš©ì ì‹ë³„ ì •ë³´ ì €ì¥

ì´ê±¸ í•˜ë‹¤ê°€ ìƒê°ë‚œ ì›¹ì†Œì¼“ ì¸ì¦ì¸ê°€ ê°œë°œê¸°

<aside>
ğŸ¤”

### ì›¹ì†Œì¼“ ì—°ê²°í• ë•Œ ì¸ì¦ì¸ê°€ ë° ë³´ì•ˆ ê³ ë ¤í•˜ëŠ”ê²Œ ì–´ë ¤ì› ë˜ ê²½í—˜ì´ ìˆì–´ìš”â€¦

ë¸Œë¼ìš°ì €ëŠ” `Authorization` í—¤ë”ë¥¼ WebSocket í•¸ë“œì‰ì´í¬ì‹œì— ì§ì ‘ ì¶”ê°€í•  ìˆ˜ ì—†ë‹¤ëŠ” ì œì•½ì´ ìˆìŒ!

 [community.fly.io+4ably.com+4systemdesign.one+4](https://ably.com/blog/websocket-authentication?utm_source=chatgpt.com).

ëŒ€ì‹  ì›¹ì†Œì¼“ ì„œë²„ê°€ HTTP ì—…ê·¸ë ˆì´ë“œ ìš”ì²­ì„ í™•ì¸í•´ì„œ í—ˆê°€ëœ ì¶œì²˜ì¸ì§€ ê²€ì‚¬í›„ ì—°ê²°í•´ì¤˜ì•¼ í•¨

## **ì›¹ì†Œì¼“ ì¸ì¦ êµ¬í˜„ ë°©ë²•ë“¤**

### **1. Query Parameter ë°©ì‹ (ê°€ì¥ í”í•¨)**

```jsx

// í´ë¼ì´ì–¸íŠ¸
const token = await getAccessToken();
const ws = new WebSocket(`wss://api.example.com/ws?token=${token}`);

// ì„œë²„ (Node.js + Socket.io ì˜ˆì‹œ)
io.use((socket, next) => {
  const token = socket.handshake.query.token;
  jwt.verify(token, secretKey, (err, decoded) => {
    if (err) return next(new Error('Authentication error'));
    socket.userId = decoded.userId;
    next();
  });
});

```

- **ì¥ì **: êµ¬í˜„ì´ ê°„ë‹¨, ê¸°ì¡´ REST í† í° ë°©ì‹ ì—°ì¥ì„ 
- **ë‹¨ì **: URLì— í† í° ë…¸ì¶œ â†’ ì„œë²„ ë¡œê·¸, í”„ë¡ì‹œ, ë¸Œë¼ìš°ì € ìºì‹œ ë“±ì— ê¸°ë¡ ìœ„í—˜

### **2. ì²« ë©”ì‹œì§€ë¡œ ì¸ì¦**

```jsx
// í´ë¼ì´ì–¸íŠ¸
const ws = new WebSocket('wss://api.example.com/ws');
ws.onopen = () => {
  ws.send(JSON.stringify({
    type: 'auth',
    token: accessToken
  }));
};

// ì„œë²„
ws.on('message', (data) => {
  const message = JSON.parse(data);
  if (message.type === 'auth' && !ws.authenticated) {
// í† í° ê²€ì¦ í›„ ì—°ê²° ì¸ì¦ ìƒíƒœ ì„¤ì •
    ws.authenticated = true;
    ws.userId = decoded.userId;
  }
});

```

- **ì¥ì **: URLì— í† í° ë…¸ì¶œë˜ì§€ ì•Šê³ , ì¸ì¦ í† í°ë§Œ ìµœì´ˆ ë©”ì‹œì§€ì—ì„œ êµí™˜
- **ë‹¨ì **: ì¸ì¦ì´ ì§€ì—°ë˜ì–´, ì¸ì¦ ì „ ë©”ì‹œì§€ ìˆ˜ì‹  ì°¨ë‹¨ ë¡œì§ í•„ìš”

### **3. Cookie ë°©ì‹ (ì„¸ì…˜)**

```jsx

// í´ë¼ì´ì–¸íŠ¸ (ì¿ í‚¤ ìë™ ì „ì†¡)
const ws = new WebSocket('wss://api.example.com/ws');

// ì„œë²„ (Express + ws ì˜ˆì‹œ)
wss.on('connection', (ws, req) => {
  const cookies = parseCookies(req.headers.cookie);
  const sessionId = cookies.sessionId;

// ì„¸ì…˜ ê²€ì¦
  if (isValidSession(sessionId)) {
    ws.userId = getUserIdFromSession(sessionId);
  } else {
    ws.close();
  }
});

```

- **ì¥ì **: HTTP ì„¸ì…˜ ì¬ì‚¬ìš© â†’ ì¸ì¦ ë¡œì§ ë‹¨ìˆœí™”
- **ë‹¨ì **: ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ í•„ìš”, ìˆ˜í‰ í™•ì¥ì‹œ Redis/Memcached ë“± ì™¸ë¶€ ìŠ¤í† ì–´ í•„ìš”

### ë‚´ê°€ í–ˆë˜ ë°©ì‹ì€?!

ì •ë§ ê³ ë¯¼í•˜ë©´ì„œ ë§Œë“¤ì—ˆì—ˆìŒâ€¦

1. í† í° ê¸°ë°˜ ì›¹ì†Œì¼“ ì¸ì¦ì„ í•¨
    
     ì™œëƒí•˜ë©´ ì„œë²„ì— ì„¸ì…˜ ì €ì¥ì†Œë¥¼ ì •ë§ì •ë§ ë‘ê³ ì‹¶ì§€ ì•Šì•˜ìŒ
    
    ì„œë²„ ìˆ˜í‰í™•ì¥ì‹œì—ë„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ê³ ì‹¶ì—ˆìŒ
    
2. ì²˜ìŒì—ëŠ” ë§¤ ìš”ì²­ë§ˆë‹¤ ê¶Œí•œë³„ í•„í„°ë§ì„ ë¹¡ì„¸ê²Œ í† í°ìœ¼ë¡œ ëŒë¦¼
    
    â‡’ ë‚˜ì¤‘ì—ëŠ” api ë‚´ë¶€í˜¸ì¶œ ì¤„ì´ë ¤ê³  ì„¸ì…˜ ë„ì…í•˜ê¸´ í•¨(ë‚˜ë¦„ ì„±ëŠ¥ì„ ìƒê°í•˜ë ¤ëŠ” ì‹œë„ê°€ ìˆì—ˆë‹¤)
    
3. ê·¸ë¦¬ê³  ë§¤ ì¸ì¦ë§ˆë‹¤ ê¶Œí•œì´ ì•„ì§ë„ ì‚´ì•„ìˆëŠ”ê²Œ ë§ëŠ”ì§€ ì²´í¬ë¥¼ í•¨ 
    
    â‡’ ë‚˜ì¤‘ì— ë‹¤ì‹œ ë§í•˜ì§€ë§Œ ì´ê±° íŒë‹¨ ì˜ëª»í•¨â€¦ ìš°ë¦¬ ì„œë¹„ìŠ¤ ê·¸ë ‡ê²Œê¹Œì§„ ë³´ì•ˆì´ ì¤‘ìš”í•œ ì„œë¹„ìŠ¤ ì•„ë‹ˆì„¸ìš”
    

```java
@Configuration
@EnableWebSocketMessageBroker
class WebSocketConfig(
  private val authClient: AuthClient,
  private val serverClient: ServerClient,
  private val accessVerifier: AccessVerifier,
) : WebSocketMessageBrokerConfigurer {
  @Value("\${url.front}")
  val frontUrl: String = ":63343"

  override fun registerStompEndpoints(registry: StompEndpointRegistry) {
    registry.addEndpoint("/ws").setAllowedOrigins(frontUrl).withSockJS()
  }

  override fun configureMessageBroker(config: MessageBrokerRegistry) {
    config.setApplicationDestinationPrefixes("/app")
    config.enableSimpleBroker("/topic", "/queue")
  }

  override fun configureWebSocketTransport(registry: WebSocketTransportRegistration) {
    registry.setMessageSizeLimit(4 * 8192)
    registry.setTimeToFirstMessage(30000)
  }

  @Bean
  fun webSocketInterceptor(): ChannelInterceptor {
    return object : ChannelInterceptor {
      override fun preSend(
        message: Message<*>,
        channel: MessageChannel,
      ): Message<*> {
        val simpMessageType = SimpMessageHeaderAccessor.getMessageType(message.headers)
        return when (simpMessageType) {
          SimpMessageType.CONNECT -> authenticateAndSetPrincipal(message)
          SimpMessageType.SUBSCRIBE -> filterSubscriptionDestination(message)
          SimpMessageType.MESSAGE -> verifyAccess(message)
          else -> message
        }
      }
    }
  }

  private fun filterSubscriptionDestination(message: Message<*>): Message<*> {
    val destination = SimpMessageHeaderAccessor.wrap(message).destination
    if (destination != null && !destination.startsWith("/user/queue/disconnect")) {
      return verifyAccess(message)
    }
    return message
  }

  private fun authenticateAndSetPrincipal(message: Message<*>): Message<*> {
    val headerAccessor = SimpMessageHeaderAccessor.wrap(message)
    val token =
      headerAccessor.getFirstNativeHeader("Authorization")
        ?.removePrefix("Bearer ")
        ?: throw GlobalException(ErrorCode.MISSING_TOKEN)

    val userId =
      authClient.getTokenInfo(token).data?.userId
        ?: throw GlobalException(ErrorCode.INVALID_TOKEN)

    val principal = UsernamePasswordAuthenticationToken(userId, null, emptyList())
    SimpMessageHeaderAccessor.getAccessor(message, SimpMessageHeaderAccessor::class.java)?.user = principal

    return message
  }

  private fun verifyAccess(message: Message<*>): Message<*> {
    val headerAccessor = SimpMessageHeaderAccessor.wrap(message)
    val token = getTokenFromHeader(headerAccessor)
    val contextId = getContextIdFromHeader(headerAccessor)
    val type = ChatType.valueOf(getContext(headerAccessor))
    verifyAccessByType(type, token, contextId)
    return message
  }

  private fun verifyAccessByType(
    type: ChatType,
    token: String,
    contextId: String,
  ) {
    when (type) {
      ChatType.ROOM -> {
        val userId =
          authClient.getTokenInfo(token).data?.userId
            ?: throw GlobalException(ErrorCode.INVALID_TOKEN)
        accessVerifier.verifyChatRoomAccess(contextId, userId)
      }
      ChatType.SERVER -> {
        val serverList =
          serverClient.getServerList(token, GetServerCondition())
            .body?.data ?: throw GlobalException(ErrorCode.SERVER_ERROR)
        accessVerifier.verifyServerAccess(serverList, contextId)
      }
      else -> throw GlobalException(ErrorCode.INVALID_CONTEXT)
    }
  }

  private fun getTokenFromHeader(headerAccessor: SimpMessageHeaderAccessor): String {
    return headerAccessor.getFirstNativeHeader("Authorization")
      ?.removePrefix("Bearer ")
      ?: throw GlobalException(ErrorCode.MISSING_HEADER_INFO)
  }

  private fun getContextIdFromHeader(headerAccessor: SimpMessageHeaderAccessor): String {
    return headerAccessor.getFirstNativeHeader("ContextId")
      ?: throw GlobalException(ErrorCode.MISSING_HEADER_INFO)
  }

  private fun getContext(headerAccessor: SimpMessageHeaderAccessor): String {
    return headerAccessor.getFirstNativeHeader("Context")
      ?: throw GlobalException(ErrorCode.MISSING_HEADER_INFO)
  }

  override fun configureClientInboundChannel(registration: ChannelRegistration) {
    registration.interceptors(webSocketInterceptor())
  }

  @Bean
  fun corsFilter(): CorsFilter {
    val config = CorsConfiguration()
    config.allowCredentials = true
    config.addAllowedOrigin(frontUrl)
    config.addAllowedHeader("*")
    config.addAllowedMethod("*")

    val source: UrlBasedCorsConfigurationSource = UrlBasedCorsConfigurationSource()
    source.registerCorsConfiguration("/**", config)
    return CorsFilter(source)
  }
}
```

### ì„¤ëª…: í—¤ë” ê¸°ë°˜ í† í° ì „ì†¡

```kotlin
private fun authenticateAndSetPrincipal(message: Message<*>): Message<*> {
  val token = headerAccessor.getFirstNativeHeader("Authorization")
    ?.removePrefix("Bearer ")
    ?: throw GlobalException(ErrorCode.MISSING_TOKEN)
}
```

- Query parameterë³´ë‹¤ ì•ˆì „ (ë¡œê·¸ ë…¸ì¶œ ìœ„í—˜ ì—†ìŒ)
- í‘œì¤€ì ì¸ Authorization í—¤ë” ì‚¬ìš©
- Bearer í† í° í˜•ì‹ ì¤€ìˆ˜

```kotlin
return when (simpMessageType) {
  SimpMessageType.CONNECT -> authenticateAndSetPrincipal(message)     // ì—°ê²° ì‹œ ì¸ì¦
  SimpMessageType.SUBSCRIBE -> filterSubscriptionDestination(message) // êµ¬ë… ì‹œ ê¶Œí•œ í™•ì¸
  SimpMessageType.MESSAGE -> verifyAccess(message)                    // ë©”ì‹œì§€ ì „ì†¡ ì‹œ ê¶Œí•œ í™•ì¸
  else -> message
}
```

ë‹¹ì‹œì˜ ì €ëŠ” ê¶Œí•œ ì œì–´ì— ë¯¸ì³ìˆì—ˆì£  

- ì—°ê²°/êµ¬ë…/ë©”ì‹œì§€ ê° ë‹¨ê³„ë³„ ì„¸ë°€í•œ ê¶Œí•œ ì œì–´
- ì‹¤ì‹œê°„ìœ¼ë¡œ ê¶Œí•œ ë³€ê²½ ë°˜ì˜ ê°€ëŠ¥

ì™œëƒí•˜ë©´ ì±„íŒ…ë°©ì—ì„œ ì¶”ë°©ëœ ì‚¬ëŒì´ ê³„ì† ì›¹ì†Œì¼“ ì—°ê²°ë§Œìœ¼ë¡œ ê·¸ ë°©ì„ êµ¬ë…í•  ìˆ˜ ìˆê±°ë‚˜

ì£¼ì†Œë§Œ ìˆëŠ” ì‚¬ëŒì´ ë„ì²­(?)ì„ í•  ìˆ˜ ìˆëŠ” ìƒí™©ì„ ë§‰ê³ ì‹¶ì—ˆê±°ë“ ìš”

### ì»¨í…ìŠ¤íŠ¸ë³„ ì ‘ê·¼ ì œì–´

```kotlin
private fun verifyAccessByType(type: ChatType, token: String, contextId: String) {
  when (type) {
    ChatType.ROOM -> accessVerifier.verifyChatRoomAccess(contextId, userId)
    ChatType.SERVER -> accessVerifier.verifyServerAccess(serverList, contextId)
  }
}
```

- ì±„íŒ…ë°©ë³„/ì„œë²„ë³„ ì„¸ë°€í•œ ê¶Œí•œ ê´€ë¦¬
- ë‹¤ì–‘í•œ ì»¨í…ìŠ¤íŠ¸ ì§€ì›

ê·¸ëŸ¬ê³  ë‚˜ì„œ ì‹¤ì œ ë™ì‘í• ë•Œë„ í† í°ì—ì„œ ë½‘ì•„ì™€ì„œ ë§¤ë²ˆ ê¶Œí•œì„ ì¸ì¦ì‹œì¼œì£¼ê³  ìˆì—ˆëŠ”ë°

ë­”ê°€ auth ëª¨ë“ˆì— ëŒ€í•œ api ìš”ì²­ì´ ë„ˆë¬´ë„ˆë¬´ ë§ì•„ì ¸ì„œ ì›¹ì†Œì¼“ìœ¼ë¡œ ì—°ê²°í•˜ëŠ”ê±´ ì• ì´ˆì— íŠ¸ë˜í”½ ì¤„ì´ë ¤ê³  í•˜ëŠ”ê±´ë° ë‚´ë¶€ íŠ¸ë˜í”½ì´ ëŠ˜ì–´ë‚˜ëŠ”ê²ƒë„ ë­”ê°€ ì¢€ ì• ì´ˆì˜ ëª©ì ì— ì–´ê¸‹ë‚˜ëŠ” ê²ƒ ê°™ì•„ì„œ ì„¸ì…˜ì„ ë‹¤ì†Œ ë„ì…í•¨ 

ìœ„ì²˜ëŸ¼ ê¶Œí•œ í•„í„°ë§í•˜ëŠ”ê±´ ê³„ì†í•˜ê¸´ í–ˆëŠ”ë°

Spring Security FilterChainì—ì„œ ì±„íŒ…ë°© ì—°ê²°ì‹œë§ˆë‹¤ ì¸ì¦í•´ê°€ì§€ê³  

crudì—ì„œëŠ” ì´ë ‡ê²Œ í™œìš©í–ˆìŒ ê±°ê¸°ì„œ ë½‘ì€ Principalì„ ê°€ì ¸ì™€ì„œ ì‚¬ìš©

```java
@MessageMapping("/chat/update")
  fun updateChat(
    @Payload @Validated request: UpdateChatRequest,
    principal: Principal,
  ) {
    val userId = principal.name
    val contextId = request.contextId

    val result = chatService.updateChat(request, userId)
    simpMessagingTemplate.convertAndSend("/topic/chatroom/$contextId", result)
  }

```

ê·¼ë° ì € Principalì— ë‹´ëŠ” ë¶€ë¶„ì´ ìŠ¤í”„ë§ ì„¸ì…˜ì— ë‹´ëŠ”ê±°ë¼ ì–´ì°¨í”¼ í•˜ë‚˜ì˜ ìŠ¤í”„ë§ ì„œë²„ì˜ ì„¸ì…˜ì„ ì¨ì„œâ€¦ 

ì„¸ì…˜ ì €ì¥ì†Œë¥¼ ë¶„ë¦¬ì‹œí‚¤ë ¤ê³  í•˜ê³  ìˆë‹¤ê°€ í”„ë¡œì íŠ¸ê°€ ì—ì–´ì¡ŒìŠµë‹ˆë‹¤~

ì €ë•ŒëŠ” í˜¼ì ë¨¸ë¦¬ì‹¸ë§¤ê³  ì €ëŸ¬ê³  ìˆì—ˆìŒ

### ì´ë²ˆì— ê¶ê¸ˆí•´ì§„ ë‹¤ë¥¸ íšŒì‚¬ë“¤ì˜ ì—°ê²°ë°©ì‹

ë‚œ ì˜ í•œê²Œ ë§ì•˜ì„ê¹Œ?

ì¼ë‹¨ Slackì´ë‘ Discordë§Œ ì‚´í´ë´„

`ìºì‹œ`ë‘ `ë°°ì¹˜` ë§Œ ê¸°ì–µí•˜ë©´ ë¨

### Slack ë°©ì‹ (Socket Mode ê¸°ì¤€) [api.slack.com+1github.com+1](https://api.slack.com/apis/socket-mode?utm_source=chatgpt.com).

- ì•±ì€ ë¨¼ì € REST API `apps.connections.open` í˜¸ì¶œë¡œ WSS URL (ticket)ì„ ë°œê¸‰ë°›ìŒ
- ì—°ê²° ì‹œ í‹°ì¼“ ê¸°ë°˜ ì¸ì¦ ì™„ë£Œ
- ì—°ê²° ì¤‘ê°„ì—ëŠ” 15ë¶„ë§ˆë‹¤ í† í° ì¬ê²€ì¦ì„ ìˆ˜í–‰í•¨
- ì¸ì¦ ì£¼ì²´(Principal)ëŠ” ê³„ì† ì¬ì‚¬ìš©ë¨

### Discord ë°©ì‹ (ìºì‹œ + ë°°ì¹˜)

- ì—°ê²° ì‹œ í† í° í¬í•¨í•´ ì¸ì¦
- ì´í›„ í† í°ì€ **5ë¶„ TTL ìºì‹œ**ë¡œ ì €ì¥
- ì£¼ê¸° ë°±ê·¸ë¼ìš´ë“œ ë°°ì¹˜ ì‘ì—…ìœ¼ë¡œ ê²€ì¦í•˜ë©°, ì‹¤ì‹œê°„ ì²˜ë¦¬ì—ëŠ” ìºì‹œ ì‚¬ìš©
- ì¥ì : ì¸ì¦ API í˜¸ì¶œ íšŸìˆ˜ ì¤„ì„ â†’ ë„¤íŠ¸ì›Œí¬ ë¶€ë‹´ ê°ì†Œ

ê²°ë¡ ì ìœ¼ë¡œ ì´ìƒí•˜ê²Œ ì§ ê²Œ ë§ì•˜ë‹¤~

ë‚˜ëŠ” ìºì‹œì™€ ë°°ì¹˜ ì¤‘ ìºì‹œë°–ì— ì ‘ê·¼ì„ ëª»í•¨

ì´ ì±…ì„ ê³µë¶€í•˜ê³  ë‚œ ì´í›„ì— ì§°ë‹¤ë©´ ì•„ë§ˆ ë°°ì¹˜ë„ ë„£ì—ˆì„ ê²ƒ ê°™ê¸´ í•˜ë‹¤

| í•­ëª© | Slack | Discord | ë‚´ êµ¬ì¡° |
| --- | --- | --- | --- |
| ì—°ê²° ì‹œ ì¸ì¦ | âœ… `apps.connections.open` (í‹°ì¼“ ë°œê¸‰) | âœ… IDENTIFY ë©”ì‹œì§€ë¡œ í† í° ì¸ì¦ | âœ… `CONNECT` ì‹œ í† í° ì¸ì¦ |
| ì—°ê²° ì¤‘ê°„ ê²€ì¦
(ë°°ì¹˜ëƒê³ !!!) | âœ… BATCH
15ë¶„ë§ˆë‹¤ í† í° ì¬ê²€ì¦ | âœ… BATCH
5ë¶„ TTL ìºì‹œ + ë°°ì¹˜ ì¬ê²€ì¦ | âŒ NO BATCH
í•­ìƒ ìš”ì²­ë§ˆë‹¤ ì‹¤ì‹œê°„ ì¸ì¦ |
| Principal ì‚¬ìš©
(ë‚˜ë¦„ì˜ ìºì‹±) | âœ… CACHE
ì¸ì¦ ì‹œ ì„¸ì…˜ì— ì£¼ì…, ì´í›„ ì¬ì‚¬ìš© | âœ… CACHE
IDENTIFY â†’ ì„¸ì…˜ ë©”ëª¨ë¦¬ì— ë³´ê´€ | âœ… CACHE
í•œ ë²ˆ ì£¼ì… í›„ ê³„ì† ì‚¬ìš© |
| API í˜¸ì¶œ ìµœì í™” | âœ… ì£¼ê¸°ì  ì¬ê²€ì¦ìœ¼ë¡œ ì¤„ì„ | âœ… ìºì‹œë¡œ ìµœëŒ€í•œ í”¼í•¨ | âŒ ë©”ì‹œì§€ë§ˆë‹¤ í˜¸ì¶œ ë°œìƒ |

â‡’ ë‚˜ë„ ë§¤ ìš”ì²­ë§ˆë‹¤ ì¸ê°€ ë¹¡ì„¸ê²Œ ì¡ì§€ ë§ê³  ê± 15ë¶„ì€ í…€ ë‘ëŠ”ê²Œ ë‚˜ì•˜ì„ì§€ë„â€¦

â‡’ ë””ìŠ¤ì½”ë“œ ë°©ì‹ì´ë©´ ì„œë²„ì—ì„œ ë°°ì¹˜ë¥¼ ëŒë¦´ í•„ìš”ë„ ì—†ì´ TTL ë§Œë£Œë˜ë©´ í´ë¼ì—ì„œ ë‹¤ì‹œ ìš”ì²­ë³´ë‚´ë©´ ë˜ì–´ì„œ ë” ì¢‹ì€ê±°ê°™ë‹¤â€¦ 

### ìŠ¬ë™ì€ ì™œ ë””ìŠ¤ì½”ë“œì²˜ëŸ¼ TTLë¡œ ì•ˆ í•˜ê³  ì„œë²„ ë°°ì¹˜ë¥¼ ëŒë ¸ì„ê¹Œ?

- Slack SDK (Bolt) ë‚´ë¶€ì—ì„œ ë°±ê·¸ë¼ìš´ë“œ ë°°ì¹˜ ì²˜ë¦¬ë¡œ êµ¬í˜„ë¨

### ìŠ¬ë™ì€ íšŒì‚¬ìš©(ë³´ì•ˆì´ ì¤‘ìš”), ë””ìŠ¤ì½”ë“œëŠ” ê²Œì„ìš©(ì„±ëŠ¥ì´ ì¤‘ìš”)

ë””ìŠ¤ì½”ë“œëŠ” ìµœëŒ€í•œ ê²½ëŸ‰ìœ¼ë¡œ ì¤„ì—¬ì„œ íŠ¸ë˜í”½ì„ ì¤„ì´ê³  ì„œë²„ ë¶€í•˜ë„ ì¤„ì´ëŠ” ê²ƒì´ ì£¼ ëª©ì 

ì–´ì©ì§€ how discord ì³¤ì„ë•Œ ê°€ì¥ ë¨¼ì € ë‚˜ì˜¤ëŠ” ê¸€ì´ ì›¹ì†Œì¼“ íŠ¸ë˜í”½ì„ ì••ì¶•ì„ ì–´ë–»ê²Œ í•´ì„œ ì¤„ì˜€ëŠ”ì§€ì„

https://discord.com/blog/how-discord-reduced-websocket-traffic-by-40-percent 

ìŠ¬ë™ì€ ê¸°ì—…ìš©ì´ë¼ ë³´ì•ˆì´ ë” ì¤‘ìš”í•´ì„œ ì„œë²„ì—ì„œ ì¬ê²€ì¦í•œë‹¤ê³  í•¨

ì„œë²„ì—ì„œ ì¬ê²€ì¦í•˜ë©´ ì¢‹ì€ê²ƒ

- **í† í° íƒˆì·¨ ëŒ€ì‘ ê°€ëŠ¥**
    - í´ë¼ì´ì–¸íŠ¸ê°€ íƒˆì·¨ëœ í† í°ìœ¼ë¡œ ê³„ì† ì—°ê²°ì„ ìœ ì§€í•˜ê³  ìˆì–´ë„,
    - ì„œë²„ê°€ 15ë¶„ë§ˆë‹¤ ì¬ê²€ì¦í•˜ë©´ **íƒˆì·¨ëœ í† í°ì„ ì£¼ê¸°ì ìœ¼ë¡œ ì¡ì•„ë‚¼ ìˆ˜ ìˆìŒ**
- **ê¶Œí•œ ë³€ê²½ ì‹¤ì‹œê°„ ë°˜ì˜**
    - ì‚¬ìš©ìê°€ ì¡°ì§ì—ì„œ íƒˆí‡´í•˜ê±°ë‚˜ ê¶Œí•œì´ ë°”ë€Œì–´ë„,
    - **ì„œë²„ ë°°ì¹˜ê°€ ì¬ê²€ì¦í•˜ë©´ì„œ ìµœì‹  ìƒíƒœë¡œ ìë™ ë°˜ì˜ ê°€ëŠ¥**
- **í´ë¼ì´ì–¸íŠ¸ ì‹ ë¢°ë„ ë‚®ì„ ê²½ìš° ê°•ì œ ë¬´íš¨í™” ê°€ëŠ¥**
    - ì„œë²„ëŠ” ì–¸ì œë“  í† í°ì„ revoke í•˜ê³ ,
    - ë‹¤ìŒ ë°°ì¹˜ ë•Œ í•´ë‹¹ ì„¸ì…˜ì„ ëŠìŒ â†’ **ì¤‘ì•™ í†µì œ ê°€ëŠ¥**

ê²°ë¡ : ë‚˜ëŠ” ê¸°ì—…ìš©ì¸ ìŠ¬ë™ë³´ë‹¤ë„ ê¶Œí•œ ê²€ì¦ì„ ë” ë¹¡ì„¸ê²Œ í•¨â€¦

ì—´ì‹¬íˆ ìƒê°í•´ì„œ ì§°ì§€ë§Œ ì„±ëŠ¥ì„ ìœ„í•´ ì–´ëŠì •ë„ì˜ ë³´ì•ˆ íƒ€í˜‘ì ì„ ë‘ì§€ ëª»í–ˆë‹¤
ì™„ì „ë¬´ê²°í•˜ê²Œ ì§œê³ ì‹¶ì—ˆëŠ”ë° ì—”ì§€ë‹ˆì–´ì˜ ìì„¸ëŠ” ì•„ë‹ˆì—ˆë˜ ê²ƒ ê°™ìŒ

ë¬´ì—‡ì´ ì–¼ë§ˆë‚˜ ì¤‘ìš”í•œì§€ ì•ìœ¼ë¡œëŠ” ë” ìƒê°í•´ë³´ê³  ê°€ì¹˜íŒë‹¨ì„ í•´ì„œ ì„¤ê³„í•  ê²ƒ ê°™ë‹¤!

í”„ë¡œì íŠ¸ê°€ ì—ì–´ì§€ì§€ ì•Šì•˜ìœ¼ë©´ í˜¼ì ë” ìƒê°í•´ë³´ë©´ì„œ ê²°êµ­ ë°°ì¹˜ë¥¼ ëŒë¦¬ë“  í–ˆì„ê²ƒ ê°™ê¸´ í•¨!(í–‰ë³µíšŒë¡œ)

</aside>

# ì‹œíì–´ ì½”ë”©

ë‹¨ì–´ê°€ ì°¸..ìµìˆ™..í•˜ë„¤ìš”..

```sql
String id = request.getParameter("id");
String query = "select id, name from member where id = '" + id + "'";
ResultSet rs = stmt.executeQuery(query);
```

### SQL ì¸ì ì…˜ ê³µê²©!!

```sql
' or 1=1 or id = '
```

â‡’ member í…Œì´ë¸”ì˜ ëª¨ë“  ì¡°ê±´ ë‹¤ ì¡°íšŒí•¨

### SQL ì¸ì ì…˜ ë°©ì–´!!

Prepared Statementë¥¼ ì‚¬ìš© â‡’ ê°’ì„ ì•Œë§ê²Œ ë³€í™˜í•´ì„œ SQLì„ ë§Œë“¤ì–´ì¤€ë‹¤

<aside>
ğŸ¤”

### ì˜ë¬¸ì : JPAë‚˜ QueryDslì„ ì“°ë©´ ì €ëŸ´ ì¼ì´ ì—†ì§€ ì•Šë‚˜?

ë³´ì•ˆì ì¸ ë©´ì—ì„œë„ ê°•ì ì´ ìˆì—ˆì„ ê²ƒ ê°™ë‹¤~

ë‘˜ ë‹¤ ë‚´ë¶€ì ìœ¼ë¡œ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ í•´ì¤˜ì„œ SQL ì¸ì ì…˜ ê³µê²©ì„ í•  ìˆ˜ê°€ ì—†ì„ ê²ƒ ê°™ìŒ

### JPA Repository

```java

// ì´ë ‡ê²Œ ë„£ì–´ë„
memberRepository.findById("1' OR 1=1 OR id='");
// â†’ WHERE id = '1' OR 1=1 OR id=''  // ì´ë ‡ê²Œ ì•ˆ ë¨!!!

// ì‹¤ì œ ë™ì‘
memberRepository.findById("1' OR 1=1 OR id='");
// â†’ WHERE id = ?  (íŒŒë¼ë¯¸í„°: "1' OR 1=1 OR id='")// â†’ ê²°ê³¼: idê°€ ì •í™•íˆ "1' OR 1=1 OR id='" ì¸ ë ˆì½”ë“œ ì°¾ê¸°

```

### QueryDslì˜ ê²½ìš°

```sql
// ì´ë ‡ê²Œ ì‘ì„±í•˜ë©´
String userInput = "1' OR 1=1 OR id='";
queryFactory
    .selectFrom(member)
    .where(member.id.eq(userInput))  // ì•…ì˜ì  ì…ë ¥
    .fetch();

// ë‚´ë¶€ì ìœ¼ë¡œ ì´ë ‡ê²Œ ë³€í™˜ë¨
// SELECT * FROM member WHERE id = ?
// íŒŒë¼ë¯¸í„°: "1' OR 1=1 OR id='"
```

- ë‚´ë¶€ì ìœ¼ë¡œ íŒŒë¼ë¯¸í„° ë°”ì¸ë”© : íŒŒë¼ë¯¸í„°: "1' OR 1=1 OR id='" ì´ë ‡ê²Œ ë“¤ì–´ê°€ì„œ ì¸ì ì…˜ì´ ì•ˆ ë¨¹í˜
- ì¿¼ë¦¬ êµ¬ì¡° ë³€ê²½ ë¶ˆê°€ëŠ¥
- ë‚´ë¶€ì ìœ¼ë¡œ PreparedStatementë¥¼ ì‚¬ìš© = ì•ˆì „

### However ì¡°ì‹¬í•´ì•¼ í•  ê²ƒë“¤

### **1. ë™ì  ì •ë ¬/í•„ë“œëª…**

```java

// ìœ„í—˜í•  ìˆ˜ ìˆìŒ
public Page<Member> getMembers(String sortBy) {
    Sort sort = Sort.by(sortBy);// sortBy = "id); DROP TABLE member;--"
    return memberRepository.findAll(PageRequest.of(0, 10, sort));
}

// ì•ˆì „í•œ ë°©ë²•
public Page<Member> getMembers(String sortBy) {
    Set<String> allowedFields = Set.of("id", "name", "email");
    if (!allowedFields.contains(sortBy)) {
        sortBy = "id";// ê¸°ë³¸ê°’
    }
    Sort sort = Sort.by(sortBy);
    return memberRepository.findAll(PageRequest.of(0, 10, sort));
}

```

ìœ„ëŠ” ì™œ ìœ„í—˜í•˜ëƒë©´â€¦ ë‚´ë¶€ì ìœ¼ë¡œ SortëŠ” PreparedStatementë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ê³  í•¨

ìƒê°í•´ë³´ë©´ ë‹¹ì—°í•˜ë‹¤â€¦ ê°’ì´ ì•„ë‹ˆê³  ì¹¼ëŸ¼ëª…ì´ë¼ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì‚¬ìš©í• ìˆ˜ê°€ ì—†ë‹¤~

ììœ ë„ê°€ ìƒê¸°ë‹ˆê¹Œ ìœ„í—˜í•´ì§€ëŠ”ê²ƒ!

ì •ìƒì ì¸ ê²½ìš°ëŠ” ì•„ë˜ì²˜ëŸ¼ ëŒì•„ê°€ì§€ë§Œ?

```java

Sort.by("name")
// ìƒì„±ë˜ëŠ” SQL// SELECT * FROM member ORDER BY name

```

ì•…ì˜ì ìœ¼ë¡œ ì“°ê³ ì í•˜ë©´ ì´ë ‡ê²Œ ëœë‹¤â€¦!

```java

Sort.by("name; DELETE FROM member WHERE 1=1")
// ìƒì„±ë˜ëŠ” SQL// SELECT * FROM member ORDER BY name; DELETE FROM member WHERE 1=1//

```

### **2. JPQL/HQLì—ì„œ ë¬¸ìì—´ ì¡°í•©**

```java

// ìœ„í—˜!
String jpql = "SELECT m FROM Member m WHERE m." + fieldName + " = :value";
Query query = entityManager.createQuery(jpql);

// ì•ˆì „!
@Query("SELECT m FROM Member m WHERE m.name = :value")

```

### **3. Criteria API ì˜ëª» ì‚¬ìš©**

```java

// ìœ„í—˜í•  ìˆ˜ ìˆìŒ (ê±°ì˜ ì•ˆ ì¼ì–´ë‚˜ì§€ë§Œ)
CriteriaBuilder cb = entityManager.getCriteriaBuilder();
// ë™ì ìœ¼ë¡œ í•„ë“œëª…ì„ ë¬¸ìì—´ë¡œ ì¡°í•©í•˜ë©´ ìœ„í—˜

```

### **4. SpEL(Spring Expression Language) ì‚¬ìš©**

```java

// ìœ„í—˜!
@Query("SELECT m FROM Member m WHERE m.id = #{#userInput}")
// SpELì€ ì„ì˜ ì½”ë“œ ì‹¤í–‰ ê°€ëŠ¥// ì•ˆì „!
@Query("SELECT m FROM Member m WHERE m.id = :userInput")

```

## ê²½ê°ì‹¬

JPQLì„ ì“°ë©´ì„œ 

â‡’ ê³µê°„ì¸ë±ìŠ¤(MySQL Spatial Index)ê°€ ê·¸ê²ƒë°–ì— ì§€ì›í•˜ì§€ ì•Šì•˜ìŒâ€¦

ê°€ë…ì„±ì´ ë„ˆë¬´ë„ˆë¬´ ë–¨ì–´ì§€ê¸¸ë˜ ë¹Œë”íŒ¨í„´ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ í•©ì„±í•˜ëŠ” ë©”ì„œë“œë¥¼ ì§°ë˜ ê³¼ê±°ì˜ ë‚˜â€¦

ê³¼ê±°ì˜ ì €ëŠ” ì¿¼ë¦¬ë¹Œë”ë¥¼ ë§Œë“¤ì–´ JPQLì˜ ì§‘ë‚˜ê°„ ì½”ë“œ ê°€ë…ì„± ë° ì¬ì‚¬ìš©ì„±ì„ ê·¹ë„ë¡œ ì˜¬ë¦¬ê³  í–‰ë³µí–ˆì—ˆë‹¤ê³  í•©ë‹ˆë‹¤ ã…ã…â€¦

ê·¸ëŸ¬ë‚˜ ê°‘ìê¸° ë‚´ê°€ sql ì¸ì ì…˜ì— ì·¨ì•½í•œ ì½”ë“œë¥¼ ì§°ë˜ê²Œ ì•„ë‹ê¹Œ?

ì•„ë¬´ëŸ° ê³ ë ¤ë„ í•˜ì§€ ì•Šì•˜ëŠ”ë°?

í•˜ê³  ì‹ê²í•˜ì—¬ ë‹¤ì‹œ ë“¤ì—¬ë‹¤ë³´ì•˜ìŠµë‹ˆë‹¤

```java
public class PostQueryBuilder {

    private final StringBuilder jpql;
    @PersistenceContext
    private final EntityManager entityManager;
    private final Map<String, Object> parameters = new HashMap<>();

    public PostQueryBuilder(EntityManager entityManager) {
        this.entityManager = entityManager;
        this.jpql = new StringBuilder("SELECT p FROM Post p WHERE 1=1");
    }

    public PostQueryBuilder withStatus(PostStatusEnum status) {
        if (status != null) {
            jpql.append(" AND p.postStatus = :status");
            parameters.put("status", status);
        }
        return this;
    }

    public PostQueryBuilder withKeyword(String keyword) {
        if (keyword != null && !keyword.trim().isEmpty()) {
            jpql.append(" AND p.store LIKE :keyword");
            parameters.put("keyword", "%" + keyword + "%");
        }
        return this;
    }

    public PostQueryBuilder withCuisine(String cuisine) {
        if (cuisine != null && !cuisine.trim().isEmpty()) {
            jpql.append(" AND p.cuisine = :cuisine");
            parameters.put("cuisine", cuisine);
        }
        return this;
    }

    public PostQueryBuilder orderByDistance(User user) {
        Point userLocation = user.getLocation();
        if (userLocation != null) {
            jpql.append(" AND p.location IS NOT NULL ORDER BY distance(p.location, :userLocation) ASC");
            parameters.put("userLocation", userLocation);
            return andOrderByDeadline();
        }
        return orderByDeadline();
    }

    public PostQueryBuilder andOrderByDeadline() {
        jpql.append(", p.deadline DESC");
        return this;
    }

    public PostQueryBuilder orderByDeadline() {
        jpql.append(" ORDER BY p.deadline DESC");
        return this;
    }

    public TypedQuery<Post> build() {
        TypedQuery<Post> query = entityManager.createQuery(jpql.toString(), Post.class);
        parameters.forEach(query::setParameter);
        return query;
    }
}
```

```java
@RequiredArgsConstructor
@Repository
public class PostCustomRepositoryImpl implements PostCustomRepository {

    @PersistenceContext
    private final EntityManager entityManager;
    private final int PAGE_SIZE = 5;

    @Override
    public List<Post> getPosts(TypedQuery<Post> query, int page) {
        int offset = page * PAGE_SIZE;

        query.setFirstResult(offset);
        query.setMaxResults(PAGE_SIZE);

        return query.getResultList();
    }
}
```

ë‹¤ì‹œ ë³´ë‹ˆ ê³ ë ¤í–ˆë˜ê²ƒì€ ì•„ë‹ˆì§€ë§Œ íŒŒë¼ë¯¸í„° ë°”ì¸ë”©ì„ ì—´ì‹¬íˆ ì ìš©í•´ë†”ì„œ ì‚´ì•˜ë‹¤ê³  í•©ë‹ˆë‹¤ 

ë”°ë´‰ì½œë¡ ì•„ ê³ ë§ˆì›Œ~ :

í°ì¼ë‚ ë»”~

</aside>

### **ğŸ¯ 4. ì •ë¦¬ & ì ìš© ì•„ì´ë””ì–´**

- **ë‚´ê°€ ë°°ìš´ ê²ƒ í•œ ì¤„ ìš”ì•½**:â†’Â `ì´ ì¥ì„ í†µí•´ ë‚˜ëŠ” ë³´ì•ˆì„ ì–´ë–»ê²Œ í•˜ë©´ ì‹ ê²½ì“¸ ìˆ˜ ìˆì„ì§€, ë˜ ë³´ì•ˆê³¼ ì„±ëŠ¥ ì‚¬ì´ì˜ íƒ€í˜‘ì ì„ ì°¾ì•„ì•¼ í•œë‹¤ëŠ” ê²ƒì„ ì´í•´í–ˆë‹¤.`

ì›¹ì†Œì¼“ ì¸ì¦ì¸ê°€ ìƒê°í•˜ë‹¤ê°€ ì„œë¹„ìŠ¤ì—ì„œ ë³´ì•ˆì´ 70%ë¡œ ì¤‘ìš”í•œì§€ 30%ë¡œ ì¤‘ìš”í•œì§€ì— ë”°ë¼ ì„±ëŠ¥ì„ ê°œì„ í•  ìˆ˜ ìˆë‹¤ëŠ” ì¢‹ì€ ê¹¨ë‹¬ìŒì„ ì–»ìŒ

ì¢‹ì€ ê°œë°œìëŠ” ì € ê°€ì¹˜íŒë‹¨ì„ ì˜ í•˜ê³  ìµœì ì˜ ì„¤ê³„ë¥¼ í•´ë‚´ëŠ” ì‚¬ëŒì´ ì•„ë‹ê¹Œ?

ìš°ë¦¬íšŒì‚¬ëŠ” ì•„ë§ˆ 100% ë³´ì•ˆì´ ì•„ë‹ê¹Œâ€¦

---

**ğŸŒŸ 5. ì „ì²´ ë¦¬ë·°**

- **ë³„ì  í‰ê°€**Â (â­ï¸ 5ì  ë§Œì ):Â `â­ï¸â­ï¸â­ï¸â­ï¸â­ï¸`
- **ì´ë²ˆ ì±•í„°ì— ëŒ€í•œ ì´í‰**
    - ë³´ì•ˆ ë¬¸ì œë‘ ê°œë…ì„ ë‘ë£¨ë‘ë£¨ ìµí˜€ì„œ ì‹œì•¼ê°€ ë„“ì–´ì§„ ê²ƒ ê°™ë‹¤!
    - ìƒê°ë³´ë‹¤ ìœ ìµí•˜ê³  ë§¤ìš° ì¬ë¯¸ìˆì—ˆë‹¤
