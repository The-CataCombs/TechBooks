# ğŸ“š ê°œë°œ ë„ì„œ ìŠ¤í„°ë”” í…œí”Œë¦¿


### ğŸ“Œ Chapter [2]: [ëŠë ¤ì§„ ì„œë¹„ìŠ¤, ì–´ë””ì„œë¶€í„° ë´ì•¼ í• ê¹Œ]

## ğŸ“‚ 2. ë‚´ìš© ì •ë¦¬ (ìì‹ ì˜ ì–¸ì–´ë¡œ ìš”ì•½)

#### ğŸ”„ ìºì‹œ ê´€ë ¨ ì£¼ìš” íŒ¨í„´ë“¤

##### 1ï¸âƒ£ **Cache-Aside (Lazy Loading)**
ê°€ì¥ ì¼ë°˜ì ì¸ íŒ¨í„´ìœ¼ë¡œ, ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì§ì ‘ ìºì‹œë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

```java
public User getUser(Long userId) {
    // 1. ìºì‹œì—ì„œ ë¨¼ì € ì¡°íšŒ
    User user = cache.get("user:" + userId);
    
    if (user == null) {
        // 2. ìºì‹œì— ì—†ìœ¼ë©´ DB ì¡°íšŒ
        user = userRepository.findById(userId);
        
        // 3. ì¡°íšŒí•œ ë°ì´í„°ë¥¼ ìºì‹œì— ì €ì¥
        cache.put("user:" + userId, user);
    }
    
    return user;
}

public void updateUser(Long userId, String name) {
    // DB ì—…ë°ì´íŠ¸
    userRepository.update(userId, name);
    
    // ìºì‹œ ë¬´íš¨í™” (ì‚­ì œ)
    cache.evict("user:" + userId);
}
```

**ì¥ì **: í•„ìš”í•œ ë°ì´í„°ë§Œ ìºì‹œì— ì €ì¥, ìºì‹œ ì‹¤íŒ¨í•´ë„ ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘  
**ë‹¨ì **: ìºì‹œ ë¯¸ìŠ¤ ì‹œ ì§€ì—° ë°œìƒ, ìºì‹œ-DB ë¶ˆì¼ì¹˜ ê°€ëŠ¥ì„±

---

##### 2ï¸âƒ£ **Write-Through**
ë°ì´í„° ì“°ê¸° ì‹œ ìºì‹œì™€ DBì— ë™ì‹œ ì €ì¥í•˜ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.

```java
public void saveUser(User user) {
    // 1. DBì— ì €ì¥
    userRepository.save(user);
    
    // 2. ìºì‹œì—ë„ ë™ì‹œ ì €ì¥
    cache.put("user:" + user.getId(), user);
}

public User getUser(Long userId) {
    // ìºì‹œì—ì„œë§Œ ì¡°íšŒ (í•­ìƒ ìµœì‹  ë°ì´í„°)
    return cache.get("user:" + userId);
}
```

**ì¥ì **: ìºì‹œ-DB ì¼ê´€ì„± ë³´ì¥, ì½ê¸° ì„±ëŠ¥ ìš°ìˆ˜  
**ë‹¨ì **: ì“°ê¸° ì§€ì—° ì¦ê°€, ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë°ì´í„°ë„ ìºì‹œì— ì €ì¥

---

##### 3ï¸âƒ£ **Write-Behind (Write-Back)**
ìºì‹œì— ë¨¼ì € ì“°ê³ , ë‚˜ì¤‘ì— ë°°ì¹˜ë¡œ DBì— ë°˜ì˜í•˜ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.

```java
public void updateUser(Long userId, String name) {
    // 1. ìºì‹œì—ë§Œ ë¨¼ì € ì—…ë°ì´íŠ¸
    User user = cache.get("user:" + userId);
    user.setName(name);
    cache.put("user:" + userId, user, true); // dirty ë§ˆí‚¹
    
    // 2. ë³„ë„ ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì£¼ê¸°ì ìœ¼ë¡œ DB ë™ê¸°í™”
}

@Scheduled(fixedDelay = 5000)
public void syncToDatabase() {
    List<String> dirtyKeys = cache.getDirtyKeys();
    for (String key : dirtyKeys) {
        User user = cache.get(key);
        userRepository.save(user); // DB ë™ê¸°í™”
        cache.markClean(key);
    }
}
```

**ì¥ì **: ì“°ê¸° ì„±ëŠ¥ ë§¤ìš° ìš°ìˆ˜, ë°°ì¹˜ ì²˜ë¦¬ë¡œ DB ë¶€í•˜ ê°ì†Œ  
**ë‹¨ì **: ë°ì´í„° ì†ì‹¤ ìœ„í—˜, ë³µì¡í•œ êµ¬í˜„

---

##### 4ï¸âƒ£ **Refresh-Ahead**
ìºì‹œ ë§Œë£Œ ì „ì— ë¯¸ë¦¬ ìƒˆ ë°ì´í„°ë¡œ ê°±ì‹ í•˜ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.

```java
public User getUser(Long userId) {
    String key = "user:" + userId;
    CacheEntry<User> entry = cache.getEntry(key);
    
    if (entry == null) {
        // ìºì‹œ ë¯¸ìŠ¤
        User user = userRepository.findById(userId);
        cache.put(key, user, 300); // 5ë¶„ TTL
        return user;
    }
    
    // TTL 30ì´ˆ ë‚¨ì•˜ìœ¼ë©´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê°±ì‹ 
    if (entry.isNearExpiry(30)) {
        asyncRefresh(userId);
    }
    
    return entry.getValue();
}

@Async
private void asyncRefresh(Long userId) {
    User user = userRepository.findById(userId);
    cache.put("user:" + userId, user, 300);
}
```

**ì¥ì **: ìºì‹œ ë¯¸ìŠ¤ ìµœì†Œí™”, í•­ìƒ ë¹ ë¥¸ ì‘ë‹µ  
**ë‹¨ì **: ë³µì¡í•œ êµ¬í˜„, ë¶ˆí•„ìš”í•œ DB ì¡°íšŒ ê°€ëŠ¥

---

##### 5ï¸âƒ£ **Read-Through**
ìºì‹œê°€ DB ì¡°íšŒë¥¼ ëŒ€ì‹  ì²˜ë¦¬í•˜ëŠ” íŒ¨í„´ì…ë‹ˆë‹¤.

```java
// ìºì‹œ ì„¤ì •ì—ì„œ DB ì—°ë™ ì²˜ë¦¬
@Configuration
public class CacheConfig {
    
    @Bean
    public Cache<String, User> userCache() {
        return CacheBuilder.newBuilder()
            .expireAfterWrite(10, TimeUnit.MINUTES)
            .build(new CacheLoader<String, User>() {
                @Override
                public User load(String userId) {
                    // ìºì‹œ ë¯¸ìŠ¤ ì‹œ ìë™ìœ¼ë¡œ DB ì¡°íšŒ
                    return userRepository.findById(Long.valueOf(userId));
                }
            });
    }
}

// ì‚¬ìš©
public User getUser(Long userId) {
    // ìºì‹œê°€ ì•Œì•„ì„œ DB ì¡°íšŒê¹Œì§€ ì²˜ë¦¬
    return userCache.get(userId.toString());
}
```

**ì¥ì **: ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë‹¨ìˆœí™”, ì¼ê´€ëœ ë¡œë”© ë¡œì§  
**ë‹¨ì **: ìºì‹œ ì˜ì¡´ì„± ì¦ê°€, ì—ëŸ¬ ì²˜ë¦¬ ë³µì¡

---

#### - **ë‚˜ì˜ í•´ì„ / ìƒê°**:

ìºì‹œë¼ëŠ” ê²ƒì€ ê²°êµ­ DBì´ìš©ì„ ìµœì†Œí™” í•˜ê¸° ìœ„í•œ ê²ƒì´ë‹ˆ ë§Œí¼ ë¬´ì¡°ê±´ í•˜ë‚˜ë§Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì€ ì¢‹ì§€ ì•Šë‹¤ê³  ìƒê°
ìœ„ íŒ¨í„´ì„ í† ëŒ€ë¡œ ì–´ëŠ ì •ë„ ë¡œì§ì„ ì„ì–´ì•¼ í•œë‹¤ê³  ìƒê°í•¨

**1. DBì •í•©ì„±ì„ ë§ì¶”ë©´ì„œ ì„±ëŠ¥ë„ ì–´ëŠ ì •ë„ ë³´ì¥í•˜ê³  ì‹¶ë‹¤ë©´?**

ê¸°ë³¸ì ìœ¼ë¡œëŠ” cache-asideë¥¼ ì‚¬ìš©í•¨
-> DBì™€ì˜ ë¶ˆì¼ì¹˜ëŠ” ë‹¤ìŒì„ í†µí•´ í•´ê²° ê°€ëŠ¥

```plaintext
ë°ì´í„° ë³€ê²½ -> DBë³€ê²½ -> í•´ë‹¹ ìºì‹œê°€ ì¡´ì¬í•  ê²½ìš° ì œê±° ì‹œí‚¤ê¸°

ì‚¬ìš©ì ìš”ì²­ -> ìºì‹œ ì¡°íšŒ -> ìœ„ì—ì„œ ì´ë¯¸ ìºì‹œë¥¼ ì œê±°í•˜ì˜€ìœ¼ë¯€ë¡œ DBì¡°íšŒ
```
ì´ë¥¼ í†µí•´ DBì •í•©ì„±ì„ ë§ì¶œìˆ˜ ìˆìŒ

**2. ì„±ëŠ¥ì„ ë³´ì¥í•´ì•¼ í•œë‹¤ë©´?**

Hot-Key ë¬¸ì œì™€ ê°™ì´ í•´ë‹¹ ìºì‹œê°’ì„ ë§ì´ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ë¼ë©´ ë”°ë¡œ ê´€ë¦¬í•˜ë©° ë‹¤ë¥¸ íŒ¨í„´ì„ ì ìš© í•´ì•¼ í•œë‹¤ê³  ìƒê°

Refresh-Aheadë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ë©´ì„œ write-through ë˜ëŠ” write-behindë¥¼ ì‚¬ìš©í•˜ë©´ ì„±ëŠ¥ì„ ë³´ì¥

ë§Œì•½ ìœ„ì™€ ê°™ì´ ê´€ë¦¬ í•˜ì§€ ì•ŠëŠ” ê²½ìš°

```plaintext
-> hot-key ë°ì´í„° ë§Œë£Œ 
-> ìˆ˜ ë§ì€ ì‚¬ìš©ìë“¤ì´ í•´ë‹¹ í‚¤ì— ëŒ€í•˜ì—¬ ë™ì‹œ ìš”ì²­ 
-> ê° ìš”ì²­ì— ëŒ€í•´ ê°™ì€ DB ì¡°íšŒê°€ ê°™ì´ ë“¤ì–´ê°€ê²Œ ë¨
```


## ğŸ’¬ 3. ì´ì•¼ê¸°í•˜ê³  ì‹¶ì€ ì§ˆë¬¸ / í¬ì¸íŠ¸

- â“ ì§ˆë¬¸ 1: ê¸€ë¡œë²Œì´ ì•„ë‹Œ ê²½ìš°ì—ë„ CDNì´ í•„ìš”í•œì§€?
- ğŸ’­ ë” ì•Œì•„ë³´ê³  ì‹¶ì€ ê°œë…: íŠ¸ë˜í”½ ë¹„ìš©ì„ ì¤„ì´ê¸° ìœ„í•´ ì„œë²„ë¥¼ ê±°ì¹˜ì§€ ì•Šê³  ì„œë²„ì—ì„œ ë§Œë“  singing urlì— ì§ì ‘ ì ‘ê·¼í•˜ë„ë¡ í•˜ëŠ” íŒ¨í„´ì˜ ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œë¥¼ ì•Œì•„ë³´ê³  ì‹¶ìŒ

**Valet Key Pattern**

https://learn.microsoft.com/ko-kr/azure/architecture/patterns/valet-key
---

## ğŸ¯ 4. ì •ë¦¬ & ì ìš© ì•„ì´ë””ì–´

- **ë‚´ê°€ ë°°ìš´ ê²ƒ í•œ ì¤„ ìš”ì•½**:  
  â†’ `ì´ ì¥ì„ í†µí•´ ë‚˜ëŠ” ì„œë¹„ìŠ¤ê°€ ëŠë ¤ì§„ ë‹¤ì–‘í•œ ì´ìœ ë¥¼ ì•Œê²Œë˜ì—ˆë‹¤.`
    


